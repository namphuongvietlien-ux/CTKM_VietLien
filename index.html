<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n L√Ω CTKM</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <style>
    /* UI FIX */
    select, option, .form-select, .form-control {
      background-color: #ffffff !important;
      color: #000000 !important;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #f4f6f9;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }
    .main-interface {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 10px;
      box-sizing: border-box;
    }
    #visualization {
      flex: 1;
      width: 100%;
      border: 1px solid #ccc;
      background: white;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
    }

    /* TIMELINE HEADER */
    .vis-time-axis .vis-text.vis-major {
      font-weight: 800;
      font-size: 16px;
      color: #B71C1C;
      top: 3px;
    }
    .vis-time-axis .vis-text.vis-minor {
      font-weight: 700;
      font-size: 13px;
      color: #0D47A1;
    }
    .vis-panel.vis-top, .vis-time-axis {
      background-color: #f1f3f5;
      border-bottom: 2px solid #dee2e6;
    }

    /* ITEM STYLE */
    .vis-item {
      border-color: #0d6efd;
      background-color: #e7f1ff;
      color: #000;
      border-radius: 2px;
      font-size: 12px;
      border-width: 1px;
    }
    .item-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 4px;
      line-height: 1.2;
    }
    .item-sys {
      font-weight: bold;
      color: #d63384;
      font-size: 11px;
      text-transform: uppercase;
    }
    .item-sku {
      font-weight: bold;
      font-size: 13px;
      color: #0d6efd;
      margin: 1px 0;
    }
    .item-promo {
      font-size: 11px;
      color: #333;
    }
    .item-price {
      font-weight: bold;
      color: #dc3545;
      font-size: 12px;
      margin-top: 2px;
    }

    /* LINES */
    .vis-custom-time {
      background-color: #dc3545 !important;
      width: 2px !important;
      z-index: 999;
      pointer-events: none;
    }
    .vis-custom-time .vis-custom-time-marker {
      background-color: #dc3545 !important;
      color: white !important;
      font-size: 11px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 3px;
      top: -35px !important;
      transform: translateX(-50%);
      border: none;
    }
    .vis-item.vis-background.range-highlight {
      background-color: rgba(220, 53, 69, 0.1) !important;
      border: none;
      z-index: 0;
    }

    /* PRINT CSS */
    #printArea { display: none; }

    /* ===== MOBILE RESPONSIVE ===== */
    @media (max-width: 768px) {
      html, body {
        height: auto;
        overflow-y: auto;
      }
      .main-interface {
        height: auto;
        min-height: 100vh;
        padding: 8px;
        flex-direction: column;
      }
      
      /* Header responsive */
      .d-flex.justify-content-between {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px !important;
      }
      
      h3 {
        font-size: 18px !important;
        text-align: center;
      }
      
      #visualization {
        flex: none;
        height: 400px;
        margin-bottom: 15px;
      }
      
      /* Button responsive */
      .btn {
        font-size: 12px !important;
        padding: 6px 8px !important;
        white-space: nowrap;
      }
      
      .btn i {
        margin-right: 4px;
      }
      
      /* Select dropdown responsive */
      #view_mode_select {
        font-size: 12px !important;
        padding: 6px !important;
      }
      
      #view_mode_label {
        display: none;
      }
      
      /* Breadcrumb responsive */
      #breadcrumb_area {
        font-size: 12px !important;
        padding: 8px !important;
        margin-bottom: 10px !important;
      }
      
      /* Modal responsive */
      .modal-dialog {
        margin: 10px !important;
      }
      
      .modal-lg, .modal-xl {
        max-width: 95vw !important;
      }
      
      .modal-body {
        padding: 10px !important;
      }
      
      /* Form responsive */
      .col-md-4 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
        margin-bottom: 10px !important;
      }
      
      .form-select, .form-control, .form-control-sm {
        font-size: 13px !important;
        padding: 8px !important;
      }
      
      label {
        font-size: 13px !important;
        margin-bottom: 4px !important;
      }
      
      /* Table responsive - Stack on mobile */
      .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .table-sm {
        font-size: 11px !important;
      }
      
      .table-sm th,
      .table-sm td {
        padding: 4px 2px !important;
      }
      
      .table thead {
        position: relative;
      }
      
      /* SKU input table */
      #sku_input_area {
        padding: 8px !important;
        margin-bottom: 10px !important;
      }
      
      #sku_input_area .table {
        margin-bottom: 0 !important;
        font-size: 11px !important;
      }
      
      #sku_input_area input {
        font-size: 12px !important;
        padding: 4px !important;
      }
    }

    @media (max-width: 480px) {
      h3 {
        font-size: 16px !important;
      }
      
      #visualization {
        height: 300px;
      }
      
      .btn {
        font-size: 11px !important;
        padding: 5px 6px !important;
      }
      
      .btn i {
        margin-right: 3px;
      }
      
      #breadcrumb_area {
        font-size: 11px !important;
      }
      
      .modal-dialog {
        max-width: 100vw !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      
      .modal-content {
        border-radius: 0 !important;
      }
      
      .form-select, .form-control {
        font-size: 12px !important;
      }
      
      label {
        font-size: 12px !important;
      }
    }

    @media print {
      .main-interface, .modal, .modal-backdrop {
        display: none !important;
      }
      body {
        margin: 0 !important;
        padding: 0 !important;
        height: auto;
        overflow: visible;
        background: #fff !important;
      }
      #printArea {
        display: flex !important;
        flex-direction: column;
        font-family: 'Times New Roman', serif;
        color: #000;
        width: 100%;
        padding: 2.5cm;
        box-sizing: border-box;
      }
      @page {
        size: A4 landscape;
        margin: 0;
      }
      .print-title h2 {
        font-size: 24px;
        font-weight: bold;
        text-align: center;
      }
      .print-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        margin-bottom: 20px;
        font-size: 11px;
        table-layout: auto;
      }
      .print-table th,
      .print-table td {
        white-space: nowrap;
        overflow: visible;
      }
      .print-table th:nth-child(3),
      .print-table td:nth-child(3) {
        white-space: normal;
        word-wrap: break-word;
      }
      .print-table th:nth-child(6),
      .print-table td:nth-child(6) {
        white-space: normal;
        word-wrap: break-word;
      }
      .print-table th:nth-child(10),
      .print-table td:nth-child(10) {
        white-space: normal;
        word-wrap: break-word;
      }
      .print-table th,
      .print-table td {
        border: 1px solid #000 !important;
        padding: 6px 4px;
        vertical-align: middle;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.4;
      }
      .print-table th {
        background-color: #f3f3f3 !important;
        font-weight: bold;
        text-transform: uppercase;
        text-align: center;
        font-size: 11px;
        padding: 10px 6px;
      }
      .print-table td {
        font-size: 11px;
        min-height: 25px;
        height: 25px;
        padding: 8px 6px;
      }
      .print-table tbody tr {
        min-height: 25px;
        height: 25px;
      }
      .text-end { text-align: right !important; }
      .text-center { text-align: center !important; }
      .fw-bold { font-weight: bold !important; }
      .signature-section {
        margin-top: 50px;
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
        page-break-inside: avoid;
        width: 100%;
        padding: 0 5%;
      }
      .signature-box {
        flex: 0 0 auto;
        text-align: center;
        min-height: 200px;
        width: 30%;
        max-width: 200px;
      }
      .signature-label {
        font-weight: bold;
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 120px;
        display: block;
        line-height: 1.5;
      }
      .signature-name {
        font-weight: bold;
        font-size: 12px;
        text-transform: uppercase;
        margin-top: 5px;
        line-height: 1.5;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
    }
  </style>
</head>
<body>
  <div class="main-interface">
    <div class="d-flex justify-content-between align-items-center mb-2" style="height: 40px;">
      <h3 class="text-primary fw-bold m-0">
        <i class="fa-solid fa-timeline"></i> Qu·∫£n L√Ω CTKM
      </h3>
      <div class="d-flex align-items-center gap-2">
        <div class="me-2 d-flex align-items-center">
          <select id="view_mode_select" class="form-select form-select-sm me-2" onchange="onViewModeChange()" title="Ch·ªçn c√°ch hi·ªÉn th·ªã">
            <option value="system">H·ªá th·ªëng ‚Üí SKU ‚Üí Timeline</option>
            <option value="sku">SKU ‚Üí H·ªá th·ªëng ‚Üí Timeline</option>
          </select>
          <small id="view_mode_label" class="me-2 text-muted" style="font-size:12px">H·ªá th·ªëng ‚Üí SKU ‚Üí Timeline</small>

          <!-- System filter -->
          <select id="system_filter_select" class="form-select form-select-sm" onchange="onSystemFilterChange()" title="L·ªçc theo h·ªá th·ªëng">
            <option value="">-- T·∫•t c·∫£ h·ªá th·ªëng --</option>
          </select>
        </div>
        <div>
        <button class="btn btn-success fw-bold shadow-sm me-2" onclick="openGuidelineModal()">
          <i class="fa-solid fa-book"></i> GUIDELINE
        </button>
        <button class="btn btn-info fw-bold shadow-sm me-2" onclick="openPrintTimelineModal()">
          <i class="fa-solid fa-file-pdf"></i> IN TIMELINE
        </button>
        <button class="btn btn-warning fw-bold shadow-sm me-2" onclick="openPrintModal()">
          <i class="fa-solid fa-print"></i> IN & T·∫¢I FILE
        </button>
        <button class="btn btn-primary shadow-sm" onclick="openModal()">
          <i class="fa-solid fa-plus"></i> Th√™m M·ªõi
        </button>
        </div>
      </div>
    </div>
    <div id="breadcrumb_area" class="mb-2 ps-2 d-flex justify-content-between align-items-center flex-wrap" style="min-height:26px; background:#f8f9fa; border-left:3px solid #0d6efd; border-radius:2px; padding-right: 8px;">
      <small id="breadcrumb" class="text-secondary" style="font-size:13px">
        <i class="fa-solid fa-sitemap me-1"></i>H·ªá th·ªëng ‚Üí SKU ‚Üí Timeline
      </small>
      <div class="d-flex gap-2 align-items-center" style="font-size: 10px;">
        <span class="badge" style="background-color: #e7f1ff; color: #000; border: 1px solid #0d6efd; padding: 3px 6px;">Kh√¥ng guideline</span>
        <span class="badge" style="background-color: #d4edda; color: #000; border: 1px solid #28a745; padding: 3px 6px;">‚úì ƒê√∫ng guideline</span>
        <span class="badge" style="background-color: #fff3cd; color: #000; border: 1px solid #ffc107; padding: 3px 6px;">‚ö† Sai guideline</span>
      </div>
    </div>
    <div id="visualization"></div>
  </div>

  <!-- PRINT AREA -->
  <div id="printArea">
    <!-- 1. TH√îNG TIN C√îNG TY: CƒÉn tr√°i, font 10, in th∆∞·ªùng -->
    <div style="margin-bottom:15px;text-align:left">
      <div style="font-weight:normal;font-size:10px;margin-bottom:3px;text-transform:none">C√¥ng ty TNHH Vi·ªát Li√™n</div>
      <div style="font-size:10px;font-weight:normal;line-height:1.5">
        Ph√≤ng 06, T·∫ßng 19, T√≤a nh√† Golden King, S·ªë 15 Nguy·ªÖn L∆∞∆°ng B·∫±ng, P.T√¢n M·ªπ, Q.7, TP.HCM<br>
        ƒêT: 028.54136608   FAX: 028.5413.6607<br>
        Email: donhang@vietlien.vn
      </div>
    </div>

    <!-- TI√äU ƒê·ªÄ: CƒÉn gi·ªØa, in hoa, Bold, size 18 -->
    <div class="text-center" style="margin:15px 0">
      <h2 style="font-size:18px;font-weight:bold;text-transform:uppercase;margin:10px 0;letter-spacing:0.5px">CH∆Ø∆†NG TR√åNH KHUY·∫æN M√ÉI</h2>
    </div>

    <!-- M√É CTKM V√Ä TH·ªúI GIAN: CƒÉn gi·ªØa, size 11, in nghi√™ng -->
    <div class="text-center" style="font-size:11px;font-style:italic;margin-bottom:8px">
      H·ªá th·ªëng: <strong id="p_system"></strong> - M√£: <strong id="p_code"></strong>
    </div>

    <div class="text-center" style="font-size:11px;font-style:italic;color:#d32f2f;margin-bottom:5px">
      Th·ªùi gian khuy·∫øn m√£i t·ª´: <span id="p_dateRange"></span>
    </div>

    <div class="text-center" style="font-size:11px;font-style:italic;margin-bottom:10px">
      Th·ªùi gian Giao H√†ng: <span id="p_delRange"></span>
    </div>

    <table class="print-table" id="printTableObj">
      <thead>
        <tr>
          <th rowspan="2">STT</th>
          <th rowspan="2">M√É V·∫†CH</th>
          <th rowspan="2">T√äN S·∫¢N PH·∫®M</th>
          <th rowspan="2">GI√Å</th>
          <th colspan="2">CTKM NTD</th>
          <th rowspan="2">GI√Å KM</th>
          <th rowspan="2">SLƒêK</th>
          <th rowspan="2">TH√ÄNH TI·ªÄN</th>
          <th rowspan="2">GHI CH√ö</th>
        </tr>
        <tr>
          <th>H√åNH TH·ª®C</th>
          <th>T·∫∂NG K√àM</th>
        </tr>
      </thead>
      <tbody id="p_tbody"></tbody>
      <tfoot>
        <tr>
          <td colspan="7" class="text-end fw-bold">T·ªîNG C·ªòNG (TOTAL)</td>
          <td id="p_total_qty" class="text-end fw-bold">0</td>
          <td id="p_total_amount" class="text-end fw-bold">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="text-end" style="margin-top:30px;margin-bottom:20px;font-style:italic;font-size:11px">
      TP.HCM, Ng√†y <span id="p_day"></span> th√°ng <span id="p_month"></span> nƒÉm <span id="p_year"></span>
    </div>

    <div class="signature-section">
      <div class="signature-box">
        <span class="signature-label">NG∆Ø·ªúI ƒê·ªÄ NGH·ªä</span>
        <div class="signature-name" id="p_proposer_name"></div>
      </div>
      <div class="signature-box">
        <span class="signature-label">K·∫æ TO√ÅN</span>
        <div class="signature-name">CHUNG THANH HU·ªÜ</div>
      </div>
      <div class="signature-box">
        <span class="signature-label">GI√ÅM ƒê·ªêC</span>
        <div class="signature-name">NGUY·ªÑN TH·ªä THU H·∫∞NG</div>
      </div>
    </div>
  </div>

  <!-- PRINT MODAL -->
  <div class="modal fade" id="printModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title fw-bold">In & T·∫£i File</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              <label class="fw-bold">1. H·ªá Th·ªëng</label>
              <select class="form-select" id="print_system" onchange="loadPrintCtkmList()">
                <option value="">-- Ch·ªçn --</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label class="fw-bold">2. Nh√£n (Brand)</label>
              <select class="form-select" id="print_brand" onchange="loadPrintCtkmList()">
                <option value="">-- T·∫•t c·∫£ --</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label class="fw-bold">3. M√£ CTKM</label>
              <select class="form-select" id="print_ctkm" onchange="renderSkuInputTable()" disabled>
                <option value="">-- Ch·ªçn --</option>
              </select>
              <small class="text-muted" id="print_timeline_info"></small>
            </div>
            <div class="col-md-3 mb-3">
              <label class="fw-bold">4. Ng∆∞·ªùi ƒë·ªÅ ngh·ªã</label>
              <input type="text" class="form-control" id="print_proposer" placeholder="VD: L√ä NAM PH∆Ø∆†NG">
            </div>
          </div>

          <div id="sku_input_area" class="mb-3" style="display:none; background:#f8f9fa; padding:10px">
            <label class="fw-bold text-primary">4. Chi ti·∫øt:</label>
            <div style="max-height:300px; overflow-y:auto">
              <table class="table table-sm table-bordered bg-white mb-0 align-middle">
                <thead class="table-light sticky-top">
                  <tr>
                    <th>SKU</th>
                    <th>CTKM</th>
                    <th>SLƒêK</th>
                    <th>T·∫∑ng K√®m</th>
                  </tr>
                </thead>
                <tbody id="sku_input_tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-info text-white fw-bold me-auto" onclick="viewReport()">DOANH S·ªê</button>
          <button class="btn btn-success fw-bold" onclick="exportToExcel()">T·∫¢I EXCEL</button>
          <button class="btn btn-warning fw-bold" onclick="executePrint()">IN PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- REPORT MODAL -->
  <div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title fw-bold">Hi·ªáu Qu·∫£ CTKM</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <div id="report-loading" class="spinner-border text-info"></div>
          <div id="report-content" style="display:none">
            <h5 id="rpt_name" class="text-primary fw-bold"></h5>
            <p id="rpt_time" class="mb-3"></p>
            <div class="row">
              <div class="col-6">
                <div class="card border-success">
                  <div class="card-body">
                    <h3 id="rpt_qty" class="text-success fw-bold"></h3>
                    <small>S·ªë l∆∞·ª£ng</small>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card border-warning">
                  <div class="card-body">
                    <h6 id="rpt_rev" class="text-warning fw-bold"></h6>
                    <small>Doanh thu</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 mt-3">
              <div style="max-height:300px;overflow-y:auto">
                <table class="table table-sm table-striped text-start" style="font-size:12px">
                  <thead>
                    <tr>
                      <th>SKU</th>
                      <th class="text-end">SL</th>
                      <th class="text-end">Ti·ªÅn</th>
                    </tr>
                  </thead>
                  <tbody id="rpt_details"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DATA MODAL -->
  <div class="modal fade" id="dataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalTitle">Th√™m M·ªõi</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="promoForm">
            <input type="hidden" id="editMode" value="create">
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="fw-bold">T√™n CTKM</label>
                <input type="text" class="form-control" id="name" required>
                <small class="text-muted" id="timeline_info"></small>
              </div>
              <div class="col-md-3">
                <label>Th√°ng</label>
                <input type="number" class="form-control" id="month" value="11" onchange="onMonthYearChange()">
              </div>
              <div class="col-md-3">
                <label>NƒÉm</label>
                <input type="number" class="form-control" id="year" value="2025" onchange="onMonthYearChange()">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-12">
                <label class="fw-bold">CTKM c√≥ s·∫µn trong th√°ng</label>
                <select class="form-select" id="existing_ctkm" onchange="onSelectExistingCtkm()">
                  <option value="">-- Ch·ªçn CTKM c√≥ trong Timeline ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·∫°o m·ªõi --</option>
                </select>
              </div>
            </div>

            <div class="card bg-light mb-3">
              <div class="card-body">
                <h6 class="text-primary fw-bold mb-3">Ch·ªçn H√†ng H√≥a</h6>
                <div class="row mb-2">
                  <div class="col-md-4">
                    <label>H·ªá Th·ªëng</label>
                    <select class="form-select" id="system" onchange="onSystemChange_Add()"></select>
                  </div>
                  <div class="col-md-4">
                    <label>Brand</label>
                    <select class="form-select" id="brand" onchange="onBrandChange_Add()" disabled></select>
                  </div>
                </div>

                <div id="add_sku_area" style="display:none; max-height:300px; overflow-y:auto">
                  <table class="table table-bordered table-hover bg-white align-middle">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th style="width:40px" class="text-center">
                          <input type="checkbox" onclick="toggleAllSku(this)">
                        </th>
                        <th>M√£ SKU</th>
                        <th>Gi√° G·ªëc</th>
                        <th style="width:150px">M·ª©c Gi·∫£m</th>
                        <th style="width:200px">T·∫∑ng K√®m</th>
                      </tr>
                    </thead>
                    <tbody id="add_sku_tbody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="fw-bold">Th·ªùi gian</label>
                <input type="text" class="form-control" id="date_range">
              </div>
              <div class="col-md-6">
                <label class="fw-bold">Giao h√†ng tr∆∞·ªõc</label>
                <select class="form-select" id="delivery_offset">
                  <option value="0">0 ng√†y</option>
                  <option value="7">7 ng√†y</option>
                  <option value="14">14 ng√†y</option>
                  <option value="21">21 ng√†y</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label>Ghi ch√∫</label>
              <input class="form-control" id="note">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success fw-bold" onclick="saveBatchData()">L∆ØU T·∫§T C·∫¢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DRAG DROP MODAL -->
  <div class="modal fade" id="dragDropModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title fw-bold">Ch·ªçn CTKM M·ªõi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="fw-bold">CTKM c≈©:</label>
            <div class="text-muted" id="dd_old_ctkm"></div>
          </div>
          <div class="mb-3">
            <label class="fw-bold">Th·ªùi gian m·ªõi:</label>
            <div class="text-primary" id="dd_new_dates"></div>
          </div>
          <div class="mb-3">
            <label class="fw-bold">T√™n CTKM m·ªõi:</label>
            <input type="text" class="form-control" id="dd_new_ctkm" placeholder="Nh·∫≠p t√™n CTKM m·ªõi ho·∫∑c ch·ªçn t·ª´ danh s√°ch">
          </div>
          <div class="mb-3">
            <label class="fw-bold">CTKM c√≥ s·∫µn trong th√°ng:</label>
            <select class="form-select" id="dd_existing_ctkm" onchange="onSelectDragDropCtkm()">
              <option value="">-- Ch·ªçn CTKM c√≥ s·∫µn ho·∫∑c nh·∫≠p t√™n m·ªõi --</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="fw-bold">Giao h√†ng tr∆∞·ªõc:</label>
            <select class="form-select" id="dd_delivery_offset">
              <option value="0">0 ng√†y</option>
              <option value="7">7 ng√†y</option>
              <option value="14">14 ng√†y</option>
              <option value="21">21 ng√†y</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary fw-bold" onclick="confirmDragDrop()">C·∫¨P NH·∫¨T</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PRINT TIMELINE MODAL -->
  <div class="modal fade" id="printTimelineModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title fw-bold">In Timeline - 4 Th√°ng G·∫ßn Nh·∫•t</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="fw-bold">Hi·ªÉn th·ªã theo:</label>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="timeline_view" id="timeline_view_system" value="system" checked onchange="updateTimelinePreview()">
              <label class="btn btn-outline-secondary" for="timeline_view_system">
                <i class="fa-solid fa-layer-group me-1"></i>H·ªá th·ªëng ‚Üí SKU
              </label>
              
              <input type="radio" class="btn-check" name="timeline_view" id="timeline_view_sku" value="sku" onchange="updateTimelinePreview()">
              <label class="btn btn-outline-secondary" for="timeline_view_sku">
                <i class="fa-solid fa-tag me-1"></i>SKU ‚Üí H·ªá th·ªëng
              </label>
            </div>
          </div>
          <div class="row mb-3 g-2">
            <div class="col-6">
              <label class="fw-bold">L·ªçc H·ªá th·ªëng</label>
              <select id="print_tl_system_select" class="form-select form-select-sm" onchange="onPrintTlSystemChange()">
                <option value="">-- T·∫•t c·∫£ h·ªá th·ªëng --</option>
              </select>
            </div>
            <div class="col-6">
              <label class="fw-bold">L·ªçc Nh√£n (Brand)</label>
              <select id="print_tl_brand_select" class="form-select form-select-sm" onchange="onPrintTlBrandChange()">
                <option value="">-- T·∫•t c·∫£ nh√£n --</option>
              </select>
            </div>
          </div>
          <div id="timeline_preview_area" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; padding:15px; border-radius:4px; background:#f9f9f9">
            <div class="text-center text-muted">
              <i class="fa-solid fa-spinner fa-spin me-2"></i>ƒêang t·∫£i d·ªØ li·ªáu...
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-info text-white fw-bold" onclick="executeTimelinePrint()">
            <i class="fa-solid fa-file-pdf me-1"></i>IN PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- GUIDELINE MODAL -->
  <div class="modal fade" id="guidelineModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title fw-bold">
            <i class="fa-solid fa-book me-2"></i>Qu·∫£n L√Ω Guideline CTKM
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-12">
              <div class="alert alert-info">
                <i class="fa-solid fa-info-circle me-2"></i>
                <strong>Guideline</strong> l√† k·∫ø ho·∫°ch CTKM theo SKU v√† th√°ng/nƒÉm, √°p d·ª•ng cho t·∫•t c·∫£ h·ªá th·ªëng. 
                Khi c√≥ guideline, timeline s·∫Ω t√¥ m√†u ƒë·ªÉ nh·∫≠n bi·∫øt SKU n√†o ƒëang ch·∫°y ƒë√∫ng/sai guideline.
              </div>
            </div>
          </div>
          
          <!-- Form th√™m guideline -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa-solid fa-plus-circle me-2"></i>Th√™m/C·∫≠p nh·∫≠t Guideline</h6>
            </div>
            <div class="card-body">
              <form id="guidelineForm" onsubmit="saveGuidelineData(event)">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="fw-bold">SKU <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="guideline_sku" placeholder="Nh·∫≠p SKU" required>
                  </div>
                  <div class="col-md-2">
                    <label class="fw-bold">Th√°ng <span class="text-danger">*</span></label>
                    <select class="form-select" id="guideline_month" required>
                      <option value="">-- Ch·ªçn --</option>
                      <option value="1">Th√°ng 1</option>
                      <option value="2">Th√°ng 2</option>
                      <option value="3">Th√°ng 3</option>
                      <option value="4">Th√°ng 4</option>
                      <option value="5">Th√°ng 5</option>
                      <option value="6">Th√°ng 6</option>
                      <option value="7">Th√°ng 7</option>
                      <option value="8">Th√°ng 8</option>
                      <option value="9">Th√°ng 9</option>
                      <option value="10">Th√°ng 10</option>
                      <option value="11">Th√°ng 11</option>
                      <option value="12">Th√°ng 12</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="fw-bold">NƒÉm <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="guideline_year" placeholder="2026" min="2020" max="2099" required>
                  </div>
                  <div class="col-md-3">
                    <label class="fw-bold">Ghi ch√∫</label>
                    <input type="text" class="form-control" id="guideline_note" placeholder="Ghi ch√∫ (t√πy ch·ªçn)">
                  </div>
                  <div class="col-md-2">
                    <label class="fw-bold">&nbsp;</label>
                    <button type="submit" class="btn btn-success w-100">
                      <i class="fa-solid fa-save me-1"></i>L∆∞u
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- B·∫£ng hi·ªÉn th·ªã guideline -->
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa-solid fa-list me-2"></i>Danh s√°ch Guideline</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-hover mb-0">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th style="width: 5%">#</th>
                      <th style="width: 25%">SKU</th>
                      <th style="width: 15%">Th√°ng</th>
                      <th style="width: 15%">NƒÉm</th>
                      <th style="width: 30%">Ghi ch√∫</th>
                      <th style="width: 10%">Thao t√°c</th>
                    </tr>
                  </thead>
                  <tbody id="guideline_table_body">
                    <tr>
                      <td colspan="6" class="text-center text-muted py-4">
                        <i class="fa-solid fa-spinner fa-spin me-2"></i>ƒêang t·∫£i...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>
  <script type="text/javascript" src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>

  <script>
    // CONFIG API
    const API_URL = 'https://script.google.com/macros/s/AKfycbyvjEkiBE3lluAHk6_AOcm0vi6bTr45d7In4FWobH9WYcbOG0qz4D1sw99IaM56frvqIQ/exec';

    let masterData = {},
      currentList = [],
      guidelineData = [],
      flatpickrInstance,
      timeline;

    // view mode: 'system' -> H·ªá th·ªëng ‚Üí SKU ‚Üí Timeline (default)
    // or 'sku' -> SKU ‚Üí H·ªá th·ªëng ‚Üí Timeline
    let viewMode = 'system';

    const modalData   = new bootstrap.Modal(document.getElementById('dataModal'));
    const modalPrint  = new bootstrap.Modal(document.getElementById('printModal'));
    const modalReport = new bootstrap.Modal(document.getElementById('reportModal'));
    const modalTimelinePrint = new bootstrap.Modal(document.getElementById('printTimelineModal'));
    const modalGuideline = new bootstrap.Modal(document.getElementById('guidelineModal'));

    document.addEventListener('DOMContentLoaded', async () => {
      flatpickrInstance = flatpickr("#date_range", {
        mode: "range",
        dateFormat: "d/m/Y",
        locale: "vn"
      });

      await fetchMasterData();
      await fetchGuidelineData(); // Load guideline data
      await fetchList();

      const d = new Date();
      document.getElementById('p_day').innerText   = String(d.getDate()).padStart(2,'0');
      document.getElementById('p_month').innerText = String(d.getMonth()+1).padStart(2,'0');
      document.getElementById('p_year').innerText  = d.getFullYear();

      // initialize view mode label and breadcrumb
      try {
        const lbl = document.getElementById('view_mode_label');
        const sel = document.getElementById('view_mode_select');
        if (sel) sel.value = viewMode;
        if (lbl) lbl.innerText = viewMode === 'sku' ? 'Nh√£n ‚Üí SKU ‚Üí H·ªá th·ªëng' : 'H·ªá th·ªëng ‚Üí SKU ‚Üí Timeline';
        setBreadcrumb(viewMode);
      } catch (e) {}
    });

    function onViewModeChange() {
      const sel = document.getElementById('view_mode_select');
      if (!sel) return;
      viewMode = sel.value || 'system';
      // Update small label/breadcrumb
      const lbl = document.getElementById('view_mode_label');
      if (lbl) lbl.innerText = viewMode === 'sku' ? 'Nh√£n ‚Üí SKU ‚Üí H·ªá th·ªëng' : 'H·ªá th·ªëng ‚Üí SKU ‚Üí Timeline';
      // Update breadcrumb and re-render timeline with new view mode
      setBreadcrumb(viewMode);
      initTimeline(getFilteredList(), viewMode);
    }

    // --- 1. T√åM KI·∫æM GI√Å (SMART) ---
    function findPrice(sys, brand, sku) {
      const s = clean(sys), b = clean(brand), k = clean(sku);

      // 1. T√¨m h·ªá th·ªëng: ∆∞u ti√™n match ch√≠nh x√°c, sau ƒë√≥ m·ªõi cho ph√©p bao h√†m
      let sysKey = Object.keys(masterData).find(x => clean(x) === s);
      if (!sysKey) {
        sysKey = Object.keys(masterData).find(x => {
          const cx = clean(x);
          return cx.includes(s) || s.includes(cx);
        });
      }
      if (!sysKey) return 0;

      const brandData = masterData[sysKey];

      // 2. T∆∞∆°ng t·ª± cho brand
      let brandKey = Object.keys(brandData).find(x => clean(x) === b);
      if (!brandKey) {
        brandKey = Object.keys(brandData).find(x => {
          const cx = clean(x);
          return cx.includes(b) || b.includes(cx);
        });
      }
      if (!brandKey) return 0;

      // 3. T√¨m SKU: ∆∞u ti√™n b·∫±ng nhau tuy·ªát ƒë·ªëi, sau ƒë√≥ m·ªõi cho ph√©p bao h√†m
      let item = brandData[brandKey].find(i => clean(i.sku) === k);
      if (!item) {
        item = brandData[brandKey].find(i => {
          const cs = clean(i.sku);
          return cs.includes(k) || k.includes(cs);
        });
      }
      return item ? item : 0;
    }

    function clean(str) {
      return String(str || "").toUpperCase().replace(/[^A-Z0-9]/g, '');
    }

    // --- 2. INIT TIMELINE ---
    function initTimeline(data, mode) {
      mode = mode || viewMode || 'system';
      const container = document.getElementById('visualization');
      container.innerHTML = '';

      const groups = new vis.DataSet();
      const items  = new vis.DataSet();
      const processed = {
        brands:  new Set(),
        systems: new Set(),
        skus:    new Set()
      };

      data.sort((a, b) =>
        a.brand.localeCompare(b.brand) || a.system.localeCompare(b.system)
      );

      data.forEach((item, idx) => {
        if (!item.start_date) return;

        // Two rendering modes:
        // - 'system': Brand -> System -> SKU (existing behavior)
        // - 'sku': SKU -> System (under SKU)
        if (mode === 'system') {
          const bId = `b_${slug(item.brand)}`;
          const sId = `${bId}_s_${slug(item.system)}`;
          const kId = `${sId}_k_${slug(item.sku)}`;

          if (!processed.brands.has(bId)) {
            groups.add({ id: bId, content: item.brand, className: 'vis-group-level-brand', nestedGroups: [] });
            processed.brands.add(bId);
          }

          if (!processed.systems.has(sId)) {
            groups.add({ id: sId, content: item.system, className: 'vis-group-level-system', nestedGroups: [] });
            const g = groups.get(bId);
            if (g && g.nestedGroups) g.nestedGroups.push(sId);
            processed.systems.add(sId);
          }

          if (!processed.skus.has(kId)) {
            groups.add({ id: kId, content: item.sku, className: 'vis-group-level-sku' });
            const g2 = groups.get(sId);
            if (g2 && g2.nestedGroups) g2.nestedGroups.push(kId);
            processed.skus.add(kId);
          }

          item._groupId = `${sId}_k_${slug(item.sku)}`; // group id used for item
        } else if (mode === 'sku') {
          // Top level: SKU groups
          const kTop = `k_${slug(item.sku)}`;
          const sUnder = `${kTop}_s_${slug(item.system)}`;

          if (!processed.skus.has(kTop)) {
            groups.add({ id: kTop, content: item.sku, className: 'vis-group-level-sku', nestedGroups: [] });
            processed.skus.add(kTop);
          }

          if (!processed.systems.has(sUnder)) {
            groups.add({ id: sUnder, content: item.system, className: 'vis-group-level-system' });
            const g = groups.get(kTop);
            if (g && g.nestedGroups) g.nestedGroups.push(sUnder);
            processed.systems.add(sUnder);
          }

          item._groupId = sUnder;
        }

        let start = new Date(item.start_date);
        let end   = new Date(item.end_date);
        end.setHours(23, 59, 59, 999);

        const prod = findPrice(item.system, item.brand, item.sku);
        let priceRaw = prod.price || 0;
        let final = priceRaw;
        let hasDis = false;

        if (String(item.promotion).includes('%') && priceRaw > 0) {
          const m = String(item.promotion).match(/(\d+)%/);
          if (m) {
            final = priceRaw * (1 - parseInt(m[1], 10) / 100);
            hasDis = true;
          }
        }

        const priceHtml = priceRaw > 0
          ? (hasDis
              ? `<div class="item-price"><span class="price-original">${fmt(priceRaw)}</span> ‚ûù ${fmt(final)}</div>`
              : `<div class="item-price">${fmt(priceRaw)}</div>`
            )
          : '';

        const contentHtml = `
          <div class="item-content">
            <div class="item-sys">${item.system}</div>
            <div class="item-sku">${item.sku}</div>
            <div class="item-promo">${item.promotion}</div>
            ${priceHtml}
          </div>
        `;

        const tooltip =
          `üìå ${item.name}\nSKU: ${item.sku}\nNg√†y: ${formatDate(start)} - ${formatDate(end)}\nKM: ${item.promotion}`;

        // Choose the group id that was computed above depending on mode
        const groupId = item._groupId || (`${slug(item.brand)}_${slug(item.system)}_${slug(item.sku)}`);

        // L·∫•y m√†u s·∫Øc d·ª±a tr√™n guideline compliance
        const colors = getItemColorByGuideline(item);
        const itemStyle = `background-color: ${colors.background}; border-color: ${colors.border}; border-width: 2px;`;

        items.add({
          id: idx,
          group: groupId,
          content: contentHtml,
          start: start,
          end: end,
          type: 'range',
          title: tooltip,
          dataItem: { ...item, realStart: start, realEnd: end },
          style: itemStyle
        });
      });

      const options = {
        orientation: 'top',
        stack: true,
        zoomKey: 'ctrlKey',
        height: '100%',
        verticalScroll: true,
        start: new Date(new Date().getFullYear(), new Date().getMonth() - 1, 1),
        end:   new Date(new Date().getFullYear(), new Date().getMonth() + 2, 1),
        margin: {
          item: { horizontal: 0, vertical: 5 }
        },
        snap: null,
        // T·∫Øt k√©o th·∫£ ƒë·ªÉ tr√°nh thao t√°c sai v·ªã tr√≠
        editable: {
          updateTime: false,
          updateGroup: false,
          add: false,
          remove: false
        },
        selectable: true
      };

      timeline = new vis.Timeline(container, items, groups, options);

      timeline.on('select', p => {
        try {
          timeline.removeCustomTime('t_start');
          timeline.removeCustomTime('t_end');
          items.remove('highlight_bg');
        } catch (e) {}

        if (p.items.length) {
          const id = p.items[0];
          if (id === 'highlight_bg') return;

          const d = items.get(id).dataItem;
          const fmtS = dt =>
            `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}`;

          timeline.addCustomTime(d.realStart, 't_start');
          updateMarkerText('t_start', fmtS(d.realStart));

          timeline.addCustomTime(d.realEnd, 't_end');
          updateMarkerText('t_end', fmtS(d.realEnd));

          items.add({
            id: 'highlight_bg',
            start: d.realStart,
            end: d.realEnd,
            type: 'background',
            className: 'range-highlight'
          });
          
          // Update breadcrumb with selected item details
          setBreadcrumb(mode, d);
        }
      });

      timeline.on('doubleClick', p => {
        if (p.items && p.items.length && p.items[0] !== 'highlight_bg') {
          editItem(items.get(p.items[0]).dataItem);
        }
      });

      // update breadcrumb for this rendering (no item selected initially)
      setBreadcrumb(mode, null);

      // K√âO TH·∫¢ CTKM (ƒë√£ t·∫Øt): kh√¥ng ƒëƒÉng k√Ω moveStart/moveEnd ƒë·ªÉ tr√°nh thao t√°c sai v·ªã tr√≠
    }

    function updateMarkerText(id, t) {
      setTimeout(() => {
        const b = document.querySelector(`.vis-custom-time[data-custom-time-id="${id}"]`);
        if (b) {
          const old = b.querySelector('.custom-date-label');
          if (old) old.remove();
          const l = document.createElement('div');
          l.className = 'custom-date-label';
          l.innerText = t;
          b.appendChild(l);
        }
      }, 50);
    }

    // --- MAP INPUT FROM PRINT MODAL ---
    function getInputMap() {
      const m = {};
      document.querySelectorAll('#sku_input_tbody tr').forEach((r, i) => {
        const q = r.querySelector('.qty-input');
        const g = r.querySelector('.gift-input');
        m[i] = {
          qty:  parseInt(q.value, 10) || 0,
          gift: g.value || ''
        };
      });
      return m;
    }

    function getPrintData(n, m, system, brand) {
      const cs = clean(system);
      const cb = brand ? clean(brand) : '';

      // So kh·ªõp t√™n CTKM theo d·∫°ng ƒë√£ trim ƒë·ªÉ tr√°nh l·ªói kho·∫£ng tr·∫Øng
      const i = currentList.filter(x => {
        const sys = clean(x.system);
        const br = clean(x.brand);
        const matchSys = sys === cs || sys.includes(cs) || cs.includes(sys);
        const matchBrand = !cb || br === cb || br.includes(cb) || cb.includes(br);
        return String(x.name).trim() === String(n).trim() && matchSys && matchBrand;
      });
      
      if (!i.length) return { items: [] };

      const f = i[0];

      const p = i.map((x, idx) => {
        const prod = findPrice(x.system, x.brand, x.sku);
        let pr  = prod.price || 0;
        let bc  = prod.barcode || "";
        let nm  = prod.name || x.sku;

        let fin = pr;
        if (String(x.promotion).includes('%')) {
          const mat = String(x.promotion).match(/(\d+)%/);
          if (mat) fin = pr * (1 - parseInt(mat[1], 10) / 100);
        }

        const q = m[idx] ? m[idx].qty : 0;
        const g = (m[idx] ? m[idx].gift : '') || x.gift;
        const a = fin * q;

        return {
          barcode: bc,
          name: nm,
          priceVal: pr,
          price: fmt(pr),
          promo: x.promotion,
          gift: g,
          finalPriceVal: fin,
          priceKM: fmt(fin),
          qtyVal: q,
          qty: fmt(q),
          amountVal: a,
          amount: fmt(a),
          note: x.note || ''
        };
      });

      return {
        items: p,
        first: f,
        dateRange: `${formatDate(f.start_date)} ƒë·∫øn ${formatDate(f.end_date)}`,
        // Kh√¥ng d√πng "..." ƒë·ªÉ tr√°nh nh√¨n nh∆∞ l·ªói, ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥
        delRange: f.delivery_str || ""
      };
    }

    /**
     * Apply formatting cho Excel worksheet
     * √Åp d·ª•ng c√°c quy ƒë·ªãnh v·ªÅ layout, typography v√† spacing
     */
    /**
     * Apply formatting cho Excel worksheet - Professional Print-Ready
     * √Åp d·ª•ng c√°c quy ƒë·ªãnh v·ªÅ layout, typography v√† spacing
     */
    function applyFormatting(ws, range, headerRow, dataStartRow, totalRow, dateRow, sigHeaderRow, sigNameRow, items) {
      // Border: M√†u x√°m ƒë·∫≠m #666666 (thay v√¨ ƒëen tuy·ªÅn)
      const border = {
        top:   { style:'thin', color: { rgb: '666666' } },
        bottom:{ style:'thin', color: { rgb: '666666' } },
        left:  { style:'thin', color: { rgb: '666666' } },
        right: { style:'thin', color: { rgb: '666666' } }
      };

      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cell_ref = XLSX.utils.encode_cell({r:R, c:C});
          if (!ws[cell_ref]) continue;

          // 1. HEADER: Th√¥ng tin c√¥ng ty (Row 0-3) - C·ªôt A, size 10, ch·ªØ th∆∞·ªùng
          if (R < 4 && C === 0) {
            ws[cell_ref].s = {
              font: { sz: 10, bold: false },
              alignment: { horizontal: "left", vertical: "top" }
            };
          }
          
          // 2. TI√äU ƒê·ªÄ: Row 5, Merge A-L, Font 18, Bold, CƒÉn gi·ªØa
          if (R === 5 && C === 3) {
            ws[cell_ref].s = {
              font: { bold: true, sz: 18 },
              alignment: { horizontal: "center", vertical: "center" }
            };
          }
          
          // 3. M√£ ch∆∞∆°ng tr√¨nh v√† th·ªùi gian: Row 7-9, C·ªôt D, size 11, italic
          if (R >= 7 && R <= 9 && C === 3) {
            ws[cell_ref].s = {
              font: { sz: 11, italic: true },
              alignment: { horizontal: R === 7 ? "left" : "right", vertical: "center" }
            };
          }

          // 4. B·∫¢NG D·ªÆ LI·ªÜU
          if (R >= headerRow && R <= totalRow + 1) {
            ws[cell_ref].s = {
              border: border,
              font: { sz: 11 },
              alignment: { vertical: "middle", wrapText: true }
            };
            
            // Header row: Background #f8f9fa, ch·ªØ in hoa, Bold, CƒÉn gi·ªØa
            if (R === headerRow) {
              ws[cell_ref].s.fill = { fgColor: { rgb: "F8F9FA" } };
              ws[cell_ref].s.font = { bold: true, sz: 11 };
              ws[cell_ref].s.alignment = { horizontal: "center", vertical: "middle", wrapText: true };
            }
            
            // Data rows: CƒÉn l·ªÅ theo y√™u c·∫ßu
            if (R > headerRow && R <= totalRow) {
              // STT (C=0), M√£ v·∫°ch (C=1), SLƒêK (C=7), ƒê∆°n gi√° (C=3): CƒÉn gi·ªØa
              if (C === 0 || C === 1 || C === 7 || C === 3) {
                ws[cell_ref].s.alignment = { horizontal: "center", vertical: "middle", wrapText: true };
                // Format s·ªë cho ƒê∆°n gi√°
                if (C === 3) {
                  ws[cell_ref].z = '#,##0';
                }
              }
              // T√™n s·∫£n ph·∫©m (C=2): CƒÉn tr√°i, wrap text, width 350px
              else if (C === 2) {
                ws[cell_ref].s.alignment = { horizontal: "left", vertical: "middle", wrapText: true, indent: 1 };
              }
              // Gi√° KM (C=6), Th√†nh ti·ªÅn (C=8): CƒÉn ph·∫£i, format #,##0
              else if (C === 6 || C === 8) {
                ws[cell_ref].s.alignment = { horizontal: "right", vertical: "middle", wrapText: true };
                ws[cell_ref].z = '#,##0';
              }
              // C√°c c·ªôt kh√°c
              else {
                ws[cell_ref].s.alignment = { horizontal: C === 4 ? "center" : "left", vertical: "middle", wrapText: true };
              }
            }
            
            // T·ªïng c·ªông: "T·ªîNG C·ªòNG :" ·ªü G, s·ªë li·ªáu ·ªü H v√† I
            if (R === totalRow + 1) {
              ws[cell_ref].s.font = { bold: true, sz: 11 };
              if (C === 6) {
                ws[cell_ref].s.alignment = { horizontal: "right", vertical: "middle" };
              } else if (C === 7 || C === 8) {
                ws[cell_ref].s.alignment = { horizontal: "right", vertical: "middle" };
                ws[cell_ref].z = '#,##0';
              }
            }
          }

          // 5. Ng√†y th√°ng: merge H:I
          if (R === dateRow && C >= 7 && C <= 8) {
            ws[cell_ref].s = {
              font: { italic: true, sz: 11 },
              alignment: { horizontal: "right", vertical: "middle" }
            };
          }
          
          // 6. CH·ªÆ K√ù: Header - C·ªôt B (index 1), C·ªôt F (index 5), C·ªôt I (index 8)
          if (R === sigHeaderRow) {
            if (C === 1 || C === 5 || C === 8) {
              ws[cell_ref].s = {
                font: { bold: true, sz: 12 },
                alignment: { horizontal: "center", vertical: "middle", wrapText: true }
              };
            }
          }
          
          // Ch·ªØ k√Ω - T√™n: C·ªôt B, C·ªôt F, C·ªôt I (c√°ch ch·ª©c danh 5 d√≤ng = 100px)
          if (R === sigNameRow) {
            if (C === 1 || C === 5 || C === 8) {
              ws[cell_ref].s = {
                font: { bold: true, sz: 12 },
                alignment: { horizontal: "center", vertical: "middle", wrapText: true }
              };
            }
          }
        }
      }
    }

    /**
     * Setup column widths theo y√™u c·∫ßu
     * STT (40px), M√£ v·∫°ch (120px), T√™n SP (350px - setColumnWidth(3, 350)), Gi√°/Th√†nh ti·ªÅn (100px)
     */
    function setupColumnWidths() {
      return [
        { wch: 5 },   // STT (40px ‚âà 5 chars)
        { wch: 15 },  // M√É V·∫†CH (120px ‚âà 15 chars)
        { wch: 44 },  // T√äN S·∫¢N PH·∫®M (350px ‚âà 44 chars) - setColumnWidth(3, 350)
        { wch: 12 },  // GI√Å (-VAT) / ƒê∆°n gi√° (100px ‚âà 12 chars) - CƒÉn gi·ªØa
        { wch: 15 },  // H√åNH TH·ª®C
        { wch: 15 },  // T·∫∂NG K√àM
        { wch: 12 },  // GI√Å KM (-VAT) (100px ‚âà 12 chars)
        { wch: 8 },   // SLƒêK
        { wch: 12 },  // TH√ÄNH TI·ªÄN (100px ‚âà 12 chars)
        { wch: 15 }   // GHI CH√ö
      ];
    }

    function exportToExcel() {
      const n = document.getElementById('print_ctkm').value;
      if (!n) return alert("Ch∆∞a ch·ªçn CTKM!");

      try {
        if (typeof XLSX === 'undefined') return alert("Ch·ªù th∆∞ vi·ªán...");

        const p = getPrintData(n, getInputMap());
        if (!p.items.length) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");

        // 1. HEADER: Th√¥ng tin c√¥ng ty cƒÉn tr√°i, font 10, in th∆∞·ªùng (c·ªôt A)
        const d = [
          ["C√¥ng ty TNHH Vi·ªát Li√™n", "", "", "", "", "", "", "", "", ""],
          ["Ph√≤ng 06, T·∫ßng 19, T√≤a nh√† Golden King, S·ªë 15 Nguy·ªÖn L∆∞∆°ng B·∫±ng, P.T√¢n M·ªπ, Q.7, TP.HCM", "", "", "", "", "", "", "", "", ""],
          ["ƒêT: 028.54136608   FAX: 028.5413.6607", "", "", "", "", "", "", "", "", ""],
          ["Email: donhang@vietlien.vn", "", "", "", "", "", "", "", "", ""],
          ["", "", "", "", "", "", "", "", "", ""],
          // Ti√™u ƒë·ªÅ: cƒÉn gi·ªØa, in hoa, Bold, size 18 (merge A6:J6)
          ["CH∆Ø∆†NG TR√åNH KHUY·∫æN M√ÉI", "", "", "", "", "", "", "", "", ""],
          ["", "", "", "", "", "", "", "", "", ""],
          // M√£ CTKM v√† th·ªùi gian: cƒÉn gi·ªØa, size 11, in nghi√™ng (merge A8:J8, A9:J9, A10:J10)
          [`H·ªá th·ªëng: ${p.first.system} - M√£: ${n}`, "", "", "", "", "", "", "", "", ""],
          [`Th·ªùi gian khuy·∫øn m√£i t·ª´: ${p.dateRange}`, "", "", "", "", "", "", "", "", ""],
          [`Th·ªùi gian Giao H√†ng: ${p.delRange}`, "", "", "", "", "", "", "", "", ""],
          // C√°ch 1 h√†ng tr·ªëng sau h√†ng 10
          ["", "", "", "", "", "", "", "", "", ""],
          // Header b·∫£ng: background #f8f9fa, ch·ªØ in hoa, Bold (A12:K12)
          ["STT","M√É V·∫†CH","T√äN S·∫¢N PH·∫®M","GI√Å (-VAT)","H√åNH TH·ª®C","T·∫∂NG K√àM","GI√Å KM (-VAT)","SLƒêK","TH√ÄNH TI·ªÄN","GHI CH√ö"]
        ];

        let tQ = 0, tA = 0;

        p.items.forEach((i, x) => {
          tQ += i.qtyVal;
          tA += i.amountVal;
          d.push([
            x + 1,
            i.barcode,
            i.name,
            i.priceVal,
            i.promo,
            i.gift,
            i.finalPriceVal,
            i.qtyVal,
            i.amountVal,
            i.note
          ]);
        });

        // T·ªïng c·ªông: "T·ªîNG C·ªòNG (TOTAL):" merge 7 c·ªôt (A-G), s·ªë li·ªáu ·ªü H v√† I - gi·ªëng PDF
        d.push(["","","","","","","T·ªîNG C·ªòNG (TOTAL):",tQ,tA,""]);
        d.push([]);
        d.push([]);
        
        // Ng√†y th√°ng: merge H:J, cƒÉn gi·ªØa, ph√≠a tr√™n d√≤ng GI√ÅM ƒê·ªêC
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        d.push(["","","","","","","","",`TP.HCM, Ng√†y ${day} th√°ng ${month} nƒÉm ${year}`,""]);
        d.push([]);
        
        // Ch·ªØ k√Ω - Header: NG∆Ø·ªúI ƒê·ªÄ NGH·ªä (A:C), K·∫æ TO√ÅN (E:G), GI√ÅM ƒê·ªêC (H:J)
        d.push(["NG∆Ø·ªúI ƒê·ªÄ NGH·ªä","","","","K·∫æ TO√ÅN","","","GI√ÅM ƒê·ªêC","",""]);
        d.push([]);
        d.push([]);
        d.push([]);
        d.push([]);
        d.push([]);
        d.push([]);
        
        // Ch·ªØ k√Ω - T√™n: T√™n ng∆∞·ªùi ƒë·ªÅ ngh·ªã (A:C), CHUNG THANH HU·ªÜ (E:G), NGUY·ªÑN TH·ªä THU H·∫∞NG (H:J)
        const proposerName = document.getElementById('print_proposer').value.toUpperCase() || '';
        d.push([
          proposerName,
          "","",
          "","",
          "CHUNG THANH HU·ªÜ",
          "",
          "NGUY·ªÑN TH·ªä THU H·∫∞NG",
          "",""
        ]);

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(d);

        const range = XLSX.utils.decode_range(ws['!ref']);
        // Border: M√†u x√°m ƒë·∫≠m #666666 (thay v√¨ ƒëen tuy·ªÅn)
        const border = {
          top:   { style:'thin', color: { rgb: '666666' } },
          bottom:{ style:'thin', color: { rgb: '666666' } },
          left:  { style:'thin', color: { rgb: '666666' } },
          right: { style:'thin', color: { rgb: '666666' } }
        };

        // T√≠nh to√°n row numbers m·ªôt l·∫ßn (theo layout trong ·∫£nh)
        const headerRow = 11; // Row 12 (0-based = 11) - Header b·∫£ng (sau 1 h√†ng tr·ªëng sau h√†ng 10)
        const dataStartRow = headerRow + 1;
        const totalRow = dataStartRow + p.items.length;
        const dateRow = totalRow + 3; // Ng√†y th√°ng (sau t·ªïng c·ªông + 2 d√≤ng tr·ªëng)
        const sigHeaderRow = totalRow + 6; // Ch·ªØ k√Ω header (sau ng√†y th√°ng + 1 d√≤ng tr·ªëng)
        const sigNameRow = totalRow + 13; // T√™n ch·ªØ k√Ω (c√°ch header 6 d√≤ng tr·ªëng)
        
        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_ref = XLSX.utils.encode_cell({r:R, c:C});
            if (!ws[cell_ref]) continue;

            // 1. HEADER: Th√¥ng tin c√¥ng ty - merge A1:D1, A2:D2, A3:D3, cƒÉn tr√°i, font 10, in th∆∞·ªùng
            if (R < 3 && C >= 0 && C <= 3) {
              ws[cell_ref].s = {
                font: { sz: 10, bold: false },
                alignment: { horizontal: "left", vertical: "top", wrapText: false }
              };
            }
            // Row 4 (Email) c≈©ng merge A4:D4
            if (R === 3 && C >= 0 && C <= 3) {
              ws[cell_ref].s = {
                font: { sz: 10, bold: false },
                alignment: { horizontal: "left", vertical: "top", wrapText: false }
              };
            }
            
            // Ti√™u ƒë·ªÅ: cƒÉn gi·ªØa, in hoa, Bold, size 18 (row 6, merge A6:J6)
            if (R === 5 && C === 0) {
              ws[cell_ref].s = {
                font: { bold: true, sz: 18 },
                alignment: { horizontal: "center", vertical: "center" }
              };
            }
            
            // M√£ CTKM v√† th·ªùi gian: cƒÉn gi·ªØa, size 11, in nghi√™ng (row 8-10, merge A:J)
            if (R >= 7 && R <= 9 && C === 0) {
              ws[cell_ref].s = {
                font: { sz: 11, italic: true },
                alignment: { horizontal: "center", vertical: "middle" }
              };
            }

            // 2. B·∫¢NG D·ªÆ LI·ªÜU
            if (R >= headerRow && R <= totalRow + 1) {
              ws[cell_ref].s = {
                border: border,
                font: { sz: 11 },
                alignment: { vertical: "middle", wrapText: true }
              };
              
              // Header b·∫£ng: background #f8f9fa, ch·ªØ in hoa, Bold, CƒÉn gi·ªØa
              if (R === headerRow) {
                ws[cell_ref].s.fill = { fgColor: { rgb: "F8F9FA" } };
                ws[cell_ref].s.font = { bold: true, sz: 11 };
                ws[cell_ref].s.alignment = { horizontal: "center", vertical: "middle", wrapText: true };
              }
              
              // D√≤ng d·ªØ li·ªáu: CƒÉn l·ªÅ theo y√™u c·∫ßu
              if (R > headerRow && R <= totalRow) {
                // STT (C=0), M√£ v·∫°ch (C=1), SLƒêK (C=7): CƒÉn gi·ªØa
                if (C === 0 || C === 1 || C === 7) {
                  ws[cell_ref].s.alignment = { horizontal: "center", vertical: "middle", wrapText: true };
                }
                // T√™n s·∫£n ph·∫©m (C=2): CƒÉn tr√°i, c√≥ padding
                else if (C === 2) {
                  ws[cell_ref].s.alignment = { horizontal: "left", vertical: "middle", wrapText: true, indent: 1 };
                }
                // Gi√° (C=3), Th√†nh ti·ªÅn (C=8): CƒÉn ph·∫£i, format s·ªë
                else if (C === 3 || C === 8) {
                  ws[cell_ref].s.alignment = { horizontal: "right", vertical: "middle", wrapText: true };
                  ws[cell_ref].z = '#,##0';
                }
                // Gi√° KM (C=6): CƒÉn ph·∫£i, format s·ªë
                else if (C === 6) {
                  ws[cell_ref].s.alignment = { horizontal: "right", vertical: "middle", wrapText: true };
                  ws[cell_ref].z = '#,##0';
                }
                // C√°c c·ªôt kh√°c: cƒÉn tr√°i ho·∫∑c center t√πy n·ªôi dung
                else {
                  ws[cell_ref].s.alignment = { horizontal: C === 4 ? "center" : "left", vertical: "middle", wrapText: true };
                }
              }
              
              // D√≤ng t·ªïng c·ªông: "T·ªîNG C·ªòNG (TOTAL):" merge 7 c·ªôt (A-G), s·ªë li·ªáu ·ªü H v√† I - gi·ªëng PDF
              if (R === totalRow + 1) {
                ws[cell_ref].s.font = { bold: true, sz: 11 };
                if (C >= 0 && C <= 6) {
                  // C·ªôt A-G: "T·ªîNG C·ªòNG (TOTAL):" - cƒÉn ph·∫£i trong merged cell
                  ws[cell_ref].s.alignment = { horizontal: "right", vertical: "middle" };
                } else if (C === 7) {
                  // C·ªôt H: S·ªë l∆∞·ª£ng - cƒÉn gi·ªØa (gi·ªëng PDF)
                  ws[cell_ref].s.alignment = { horizontal: "center", vertical: "middle" };
                  ws[cell_ref].z = '#,##0';
                } else if (C === 8) {
                  // C·ªôt I: Th√†nh ti·ªÅn - cƒÉn ph·∫£i
                  ws[cell_ref].s.alignment = { horizontal: "right", vertical: "middle" };
                  ws[cell_ref].z = '#,##0';
                }
              }
            }

            // Ng√†y th√°ng: merge H:J (c·ªôt 7-9), cƒÉn gi·ªØa, ph√≠a tr√™n d√≤ng GI√ÅM ƒê·ªêC
            if (R === dateRow && C >= 7 && C <= 9) {
              ws[cell_ref].s = {
                font: { italic: true, sz: 11 },
                alignment: { horizontal: "center", vertical: "middle" }
              };
            }
            
            // 3. CH·ªÆ K√ù: Header - NG∆Ø·ªúI ƒê·ªÄ NGH·ªä (A:C), K·∫æ TO√ÅN (E:G), GI√ÅM ƒê·ªêC (H:J)
            if (R === sigHeaderRow) {
              if ((C >= 0 && C <= 2) || (C >= 4 && C <= 6) || (C >= 7 && C <= 9)) {
                ws[cell_ref].s = {
                  font: { bold: true, sz: 12 },
                  alignment: { horizontal: "center", vertical: "middle", wrapText: true }
                };
              }
            }
            
            // Ch·ªØ k√Ω - T√™n: T√™n ng∆∞·ªùi ƒë·ªÅ ngh·ªã (A:C), CHUNG THANH HU·ªÜ (E:G), NGUY·ªÑN TH·ªä THU H·∫∞NG (H:J)
            if (R === sigNameRow) {
              if ((C >= 0 && C <= 2) || (C >= 4 && C <= 6) || (C >= 7 && C <= 9)) {
                ws[cell_ref].s = {
                  font: { bold: true, sz: 12 },
                  alignment: { horizontal: "center", vertical: "middle", wrapText: true }
                };
              }
            }
          }
        }

        ws['!merges'] = [
          // Header: Th√¥ng tin c√¥ng ty - merge A1:D1, A2:D2, A3:D3, A4:D4, cƒÉn tr√°i
          { s:{r:0,c:0}, e:{r:0,c:3} }, // Row 1: C√¥ng ty TNHH Vi·ªát Li√™n
          { s:{r:1,c:0}, e:{r:1,c:3} }, // Row 2: ƒê·ªãa ch·ªâ
          { s:{r:2,c:0}, e:{r:2,c:3} }, // Row 3: ƒêT/FAX
          { s:{r:3,c:0}, e:{r:3,c:3} }, // Row 4: Email
          // Title: CH∆Ø∆†NG TR√åNH KHUY·∫æN M√ÉI (row 6, merge A6:J6)
          { s:{r:5,c:0}, e:{r:5,c:9} },
          // M√£ CTKM v√† th·ªùi gian: merge A8:J8, A9:J9, A10:J10 ƒë·ªÉ cƒÉn gi·ªØa
          { s:{r:7,c:0}, e:{r:7,c:9} }, // Row 8: H·ªá th·ªëng - M√£
          { s:{r:8,c:0}, e:{r:8,c:9} }, // Row 9: Th·ªùi gian khuy·∫øn m√£i
          { s:{r:9,c:0}, e:{r:9,c:9} }, // Row 10: Th·ªùi gian Giao H√†ng
          // T·ªïng c·ªông: merge A ƒë·∫øn F (row totalRow+1) - gi·ªëng PDF (colspan 7)
          { s:{r:totalRow + 1, c:0}, e:{r:totalRow + 1, c:6} },
          // Ng√†y th√°ng: merge H:J (c·ªôt 7-9), cƒÉn gi·ªØa, ph√≠a tr√™n d√≤ng GI√ÅM ƒê·ªêC
          { s:{r:dateRow, c:7}, e:{r:dateRow, c:9} },
          // Ch·ªØ k√Ω - Header: NG∆Ø·ªúI ƒê·ªÄ NGH·ªä (A:C), K·∫æ TO√ÅN (E:G), GI√ÅM ƒê·ªêC (H:J)
          { s:{r:sigHeaderRow, c:0}, e:{r:sigHeaderRow, c:2} }, // NG∆Ø·ªúI ƒê·ªÄ NGH·ªä (A-C)
          { s:{r:sigHeaderRow, c:4}, e:{r:sigHeaderRow, c:6} }, // K·∫æ TO√ÅN (E-G)
          { s:{r:sigHeaderRow, c:7}, e:{r:sigHeaderRow, c:9} }, // GI√ÅM ƒê·ªêC (H-J)
          // Ch·ªØ k√Ω - T√™n: T√™n ng∆∞·ªùi ƒë·ªÅ ngh·ªã (A:C), CHUNG THANH HU·ªÜ (E:G), NGUY·ªÑN TH·ªä THU H·∫∞NG (H:J)
          { s:{r:sigNameRow, c:0}, e:{r:sigNameRow, c:2} }, // T√™n ng∆∞·ªùi ƒë·ªÅ ngh·ªã (A-C)
          { s:{r:sigNameRow, c:4}, e:{r:sigNameRow, c:6} }, // CHUNG THANH HU·ªÜ (E-G)
          { s:{r:sigNameRow, c:7}, e:{r:sigNameRow, c:9} }  // NGUY·ªÑN TH·ªä THU H·∫∞NG (H-J)
        ];

        // Setup column widths
        ws['!cols'] = setupColumnWidths();

        // Set row heights: D√≤ng d·ªØ li·ªáu t·ªëi thi·ªÉu 25px (19pt), ch·ªØ k√Ω
        if (!ws['!rows']) ws['!rows'] = [];
        
        // D√≤ng d·ªØ li·ªáu: T·ª± ƒë·ªông gi√£n d√≤ng cho t√™n s·∫£n ph·∫©m d√†i (autoResizeRows logic)
        for (let r = dataStartRow; r <= totalRow; r++) {
          if (!ws['!rows'][r]) ws['!rows'][r] = {};
          // T√≠nh to√°n chi·ªÅu cao d√≤ng d·ª±a tr√™n t√™n s·∫£n ph·∫©m (c·ªôt C, index 2)
          const cellC = XLSX.utils.encode_cell({r: r, c: 2});
          if (ws[cellC] && ws[cellC].v) {
            const productName = String(ws[cellC].v);
            // ∆Ø·ªõc t√≠nh: m·ªói 50 k√Ω t·ª± = 1 d√≤ng th√™m, t·ªëi thi·ªÉu 19pt (25px)
            const estimatedLines = Math.max(1, Math.ceil(productName.length / 50));
            ws['!rows'][r].hpt = Math.max(19, 19 + (estimatedLines - 1) * 15); // TƒÉng 15pt m·ªói d√≤ng th√™m
          } else {
            ws['!rows'][r].hpt = 19; // 25px ‚âà 19pt (m·∫∑c ƒë·ªãnh)
          }
        }
        
        // D√≤ng t·ªïng c·ªông
        if (!ws['!rows'][totalRow + 1]) ws['!rows'][totalRow + 1] = {};
        ws['!rows'][totalRow + 1].hpt = 20;
        
        // Ch·ªØ k√Ω: Header v√† t√™n 20pt, kho·∫£ng tr·ªëng 5 d√≤ng (20px m·ªói d√≤ng = 100px)
        if (!ws['!rows'][sigHeaderRow]) ws['!rows'][sigHeaderRow] = {};
        ws['!rows'][sigHeaderRow].hpt = 20; // Header: 20pt
        
        if (!ws['!rows'][sigNameRow]) ws['!rows'][sigNameRow] = {};
        ws['!rows'][sigNameRow].hpt = 20; // T√™n: 20pt
        
        // Kho·∫£ng tr·ªëng gi·ªØa header v√† t√™n: 5 d√≤ng, m·ªói d√≤ng 20px (‚âà 15pt)
        for (let r = sigHeaderRow + 1; r < sigNameRow; r++) {
          if (!ws['!rows'][r]) ws['!rows'][r] = {};
          ws['!rows'][r].hpt = 15; // Kho·∫£ng tr·ªëng: 15pt (20px m·ªói d√≤ng)
        }

        XLSX.utils.book_append_sheet(wb, ws, "CTKM");
        XLSX.writeFile(wb, `CTKM_${n}.xlsx`);
      } catch (e) {
        alert('L·ªói: ' + e);
      }
    }

    async function executePrint() {
      const n = document.getElementById('print_ctkm').value;
      const s = document.getElementById('print_system').value;
      const b = document.getElementById('print_brand') ? document.getElementById('print_brand').value : '';
      const p = document.getElementById('print_proposer').value.toUpperCase();
      if (!n) return alert('Ch·ªçn CTKM!');

      const m = getInputMap();
      const btn = document.querySelector('#printModal .btn-warning');
      btn.innerHTML = '...';
      btn.disabled = true;

      try {
        const pd = getPrintData(n, m, s, b);
        const data = {
          system:      pd.first.system,
          ctkmName:    n,
          dateRange:   pd.dateRange,
          delRange:    pd.delRange,
          proposer:    p,
          totalQty:    fmt(pd.items.reduce((a,b)=>a+b.qtyVal,0)),
          totalAmount: fmt(pd.items.reduce((a,b)=>a+b.amountVal,0)),
          items:       pd.items
        };

        const r = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action:'save_pdf', data })
        });
        const j = await r.json();

        if (j.success) {
          populatePrint(data);
          modalPrint.hide();
          setTimeout(() => {
            const el = document.getElementById('printArea');
            el.style.display = 'flex';
            window.print();
            el.style.display = 'none';
            alert(j.data.message);
          }, 500);
        } else {
          alert(j.error);
        }
      } catch (e) {
        alert(e);
      } finally {
        btn.innerHTML = 'IN PDF';
        btn.disabled = false;
      }
    }

    function populatePrint(d) {
      // ƒê·∫£m b·∫£o t·∫•t c·∫£ gi√° tr·ªã kh√¥ng b·ªã undefined ho·∫∑c null, kh√¥ng hi·ªÉn th·ªã "..."
      document.getElementById('p_proposer_name').innerText = (d.proposer || '').trim();
      document.getElementById('p_system').innerText  = (d.system || '').trim();
      document.getElementById('p_code').innerText    = (d.ctkmName || '').trim();
      document.getElementById('p_dateRange').innerText = (d.dateRange || '').trim();
      document.getElementById('p_delRange').innerText   = (d.delRange || '').trim();

      // C·∫≠p nh·∫≠t ng√†y th√°ng hi·ªán t·∫°i
      const today = new Date();
      document.getElementById('p_day').innerText   = String(today.getDate()).padStart(2, '0');
      document.getElementById('p_month').innerText = String(today.getMonth() + 1).padStart(2, '0');
      document.getElementById('p_year').innerText  = today.getFullYear();

      const t = document.getElementById('p_tbody');
      t.innerHTML = '';

      let tQ = 0, tA = 0;

      d.items.forEach((i, idx) => {
        tQ += i.qtyVal;
        tA += i.amountVal;
        t.innerHTML += `
          <tr>
            <td class="text-center">${idx+1}</td>
            <td class="text-center fw-bold">${i.barcode || ''}</td>
            <td>${i.name || ''}</td>
            <td class="text-end">${i.price || '0'}</td>
            <td class="text-center">${i.promo || ''}</td>
            <td class="text-danger" style="font-size:10px">${i.gift || ''}</td>
            <td class="text-end fw-bold">${i.priceKM || '0'}</td>
            <td class="text-end fw-bold">${i.qty || '0'}</td>
            <td class="text-end fw-bold">${i.amount || '0'}</td>
            <td>${i.note || ''}</td>
          </tr>`;
      });

      document.getElementById('p_total_qty').innerText    = fmt(tQ);
      document.getElementById('p_total_amount').innerText = fmt(tA);
    }

    async function viewReport() {
      const n = document.getElementById('print_ctkm').value;
      if (!n) return alert('Ch·ªçn!');

      modalReport.show();
      document.getElementById('report-loading').style.display = 'block';
      document.getElementById('report-content').style.display = 'none';

      try {
        const r = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action:'report', data:{ name:n } })
        });
        const j = await r.json();

        if (j.success) {
          const d = j.data;
          document.getElementById('rpt_name').innerText = d.name;
          document.getElementById('rpt_time').innerText = `${d.start} - ${d.end}`;
          document.getElementById('rpt_qty').innerText  = fmt(d.qty);
          document.getElementById('rpt_rev').innerText  = fmt(d.revenue);

          const t = document.getElementById('rpt_details');
          t.innerHTML = '';

          if (d.details && d.details.length) {
            d.details.forEach(i => {
              t.innerHTML += `
                <tr>
                  <td>${i.sku}</td>
                  <td class="text-end">${fmt(i.qty)}</td>
                  <td class="text-end">${fmt(i.rev)}</td>
                </tr>`;
            });
          } else {
            t.innerHTML = '<tr><td colspan="3" class="text-center">0</td></tr>';
          }

          document.getElementById('report-loading').style.display = 'none';
          document.getElementById('report-content').style.display = 'block';
        } else {
          alert(j.error);
        }
      } catch (e) {
        alert(e);
      }
    }

    async function fetchMasterData() {
      try {
        const r = await fetch(`${API_URL}?action=masterdata`);
        const j = await r.json();
        if (j.success) {
          masterData = j.data;
          renderSys();
        }
      } catch (e) {}
    }

    async function fetchList() {
      try {
        const r = await fetch(`${API_URL}?action=list`);
        const j = await r.json();
        if (j.success) {
          currentList = j.data;
          populateSystemFilter();
          // Render timeline with current filter applied
          initTimeline(getFilteredList(), viewMode);
        }
      } catch (e) {}
    }

    // System filter helpers
    function populateSystemFilter() {
      const sel = document.getElementById('system_filter_select');
      if (!sel) return;
      const systems = new Set();
      (currentList || []).forEach(i => {
        const s = String(i.system || '').trim();
        if (s) systems.add(s);
      });
      sel.innerHTML = '<option value="">-- T·∫•t c·∫£ h·ªá th·ªëng --</option>';
      Array.from(systems).sort().forEach(s => {
        sel.innerHTML += `<option value="${s}">${s}</option>`;
      });
    }

    function getFilteredList() {
      const sel = document.getElementById('system_filter_select');
      const val = sel ? String(sel.value || '').trim() : '';
      if (!val) return currentList || [];
      return (currentList || []).filter(i => {
        const sys = String(i.system || '').trim();
        return sys === val || sys.includes(val) || val.includes(sys);
      });
    }

    function onSystemFilterChange() {
      const filtered = getFilteredList();
      initTimeline(filtered, viewMode);
      try { if (document.getElementById('printTimelineModal') && document.getElementById('timeline_preview_area')) updateTimelinePreview(); } catch(e){}
    }

    // --- Print modal helpers: populate system/brand selects and filter for printing ---
    function populatePrintTimelineModalControls() {
      const sysSel = document.getElementById('print_tl_system_select');
      const brSel = document.getElementById('print_tl_brand_select');
      if (!sysSel || !brSel) return;
      // collect systems from currentList
      const systems = new Set();
      (currentList || []).forEach(i => {
        const s = String(i.system || '').trim();
        if (s) systems.add(s);
      });
      sysSel.innerHTML = '<option value="">-- T·∫•t c·∫£ h·ªá th·ªëng --</option>';
      Array.from(systems).sort().forEach(s => sysSel.innerHTML += `<option value="${s}">${s}</option>`);

      // populate brands empty initially
      brSel.innerHTML = '<option value="">-- T·∫•t c·∫£ nh√£n --</option>';
      // if header system filter is set, preselect same
      const headerSel = document.getElementById('system_filter_select');
      if (headerSel && headerSel.value) {
        sysSel.value = headerSel.value;
        populatePrintBrandsForSystem(sysSel.value);
      }
    }

    function populatePrintBrandsForSystem(system) {
      const brSel = document.getElementById('print_tl_brand_select');
      if (!brSel) return;
      brSel.innerHTML = '<option value="">-- T·∫•t c·∫£ nh√£n --</option>';
      const brands = new Set();
      (currentList || []).forEach(i => {
        const s = String(i.system || '').trim();
        if (!system || s === system || s.includes(system) || system.includes(s)) {
          const b = String(i.brand || '').trim();
          if (b) brands.add(b);
        }
      });
      Array.from(brands).sort().forEach(b => brSel.innerHTML += `<option value="${b}">${b}</option>`);
    }

    function onPrintTlSystemChange() {
      const sys = document.getElementById('print_tl_system_select').value;
      populatePrintBrandsForSystem(sys);
      updateTimelinePreview();
    }

    function onPrintTlBrandChange() {
      updateTimelinePreview();
    }

    function getPrintFilteredList() {
      // priority: print modal selects; fallback to header system filter; else all
      const sysSel = document.getElementById('print_tl_system_select');
      const brSel = document.getElementById('print_tl_brand_select');
      const headerSel = document.getElementById('system_filter_select');

      const sysVal = sysSel ? String(sysSel.value || '').trim() : '';
      const brVal = brSel ? String(brSel.value || '').trim() : '';
      const headerVal = headerSel ? String(headerSel.value || '').trim() : '';

      const useSys = sysVal || headerVal || '';

      return (currentList || []).filter(i => {
        const sys = String(i.system || '').trim();
        const br = String(i.brand || '').trim();
        if (useSys) {
          if (!(sys === useSys || sys.includes(useSys) || useSys.includes(sys))) return false;
        }
        if (brVal) {
          if (!(br === brVal || br.includes(brVal) || brVal.includes(br))) return false;
        }
        return true;
      });
    }

    function renderSys() {
      const s = document.getElementById('system');
      s.innerHTML = '<option value="">-- Ch·ªçn --</option>';
      Object.keys(masterData).forEach(k => {
        s.innerHTML += `<option value="${k}">${k}</option>`;
      });
    }

    function openModal() {
      document.getElementById('promoForm').reset();
      document.getElementById('add_sku_area').style.display = 'none';
      document.getElementById('editMode').value = 'create';
      document.getElementById('modalTitle').innerText = 'Th√™m M·ªõi';
      // reset th√¥ng tin timeline / CTKM c√≥ s·∫µn
      document.getElementById('timeline_info').innerText = '';
      const exSel = document.getElementById('existing_ctkm');
      if (exSel) {
        exSel.innerHTML = '<option value=\"\">-- Ch·ªçn CTKM c√≥ trong Timeline ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·∫°o m·ªõi --</option>';
      }
      // Reset copy data
      window._copyCtkmSkusToTick = null;
      copyCtkmData = null;
      modalData.show();
    }

    function editItem(i) {
      document.getElementById('modalTitle').innerText = "S·ª≠a: " + i.name;
      document.getElementById('editMode').value = 'update';

      document.getElementById('name').value  = i.name;
      document.getElementById('month').value = i.month;
      document.getElementById('year').value  = i.year;
      document.getElementById('note').value  = i.note;

      if (i.start_date && i.end_date) {
        flatpickrInstance.setDate([i.start_date, i.end_date]);
      }

      modalData.show();
    }

    function onSystemChange_Add() {
      const s = document.getElementById('system').value;
      const b = document.getElementById('brand');

      b.innerHTML = '<option value="">-- Ch·ªçn --</option>';
      b.disabled = !s;
      document.getElementById('add_sku_area').style.display = 'none';

      if (s && masterData[s]) {
        Object.keys(masterData[s]).forEach(x => {
          b.innerHTML += `<option value="${x}">${x}</option>`;
        });
      }

      // c·∫≠p nh·∫≠t danh s√°ch CTKM c√≥ s·∫µn theo h·ªá th·ªëng + th√°ng/nƒÉm
      onMonthYearChange();
    }

    function onBrandChange_Add() {
      const s = document.getElementById('system').value;
      const b = document.getElementById('brand').value;
      const t = document.getElementById('add_sku_tbody');

      if (!s || !b) return;

      const skus = masterData[s][b] || [];
      t.innerHTML = '';

      if (!skus.length) {
        t.innerHTML = '<tr><td colspan="5" class="text-center">Tr·ªëng</td></tr>';
      } else {
        skus.forEach((i, idx) => {
          t.innerHTML += `
            <tr>
              <td class="text-center">
                <input type="checkbox" class="sku-check" value="${i.sku}" id="chk_${idx}">
              </td>
              <td><b>${i.sku}</b></td>
              <td>${fmt(i.price)}</td>
              <td><input type="text" class="form-control form-control-sm sku-promo"></td>
              <td><input type="text" class="form-control form-control-sm sku-gift"></td>
            </tr>`;
        });
      }

      document.getElementById('add_sku_area').style.display = 'block';

      // N·∫øu ƒëang copy CTKM, tick c√°c SKU t·ª´ CTKM c≈©
      if (window._copyCtkmSkusToTick) {
        setTimeout(() => tickCopyCtkmSkus(), 100);
      }
    }

    // Tick SKU t·ª´ CTKM c≈© khi copy
    function tickCopyCtkmSkus() {
      if (!window._copyCtkmSkusToTick || !window._copyCtkmSkusToTick.length) {
        console.log('No SKUs to tick');
        return;
      }

      console.log('Ticking SKUs:', window._copyCtkmSkusToTick.length);
      let tickedCount = 0;
      const notFoundSkus = [];

      window._copyCtkmSkusToTick.forEach(skuData => {
        const skuValue = String(skuData.sku || '').trim();
        if (!skuValue) return;

        // T√¨m checkbox b·∫±ng value (SKU) - th·ª≠ nhi·ªÅu c√°ch
        let skuCheckbox = document.querySelector(`.sku-check[value="${skuValue}"]`);
        
        // N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m b·∫±ng text trong row
        if (!skuCheckbox) {
          const allCheckboxes = document.querySelectorAll('.sku-check');
          allCheckboxes.forEach(cb => {
            const row = cb.closest('tr');
            if (row) {
              const skuCell = row.querySelector('td:nth-child(2)'); // C·ªôt SKU
              if (skuCell && skuCell.textContent.trim() === skuValue) {
                skuCheckbox = cb;
              }
            }
          });
        }

        if (skuCheckbox) {
          skuCheckbox.checked = true;
          tickedCount++;
          // Pre-fill promotion v√† gift
          const row = skuCheckbox.closest('tr');
          if (row) {
            const promoInput = row.querySelector('.sku-promo');
            const giftInput = row.querySelector('.sku-gift');
            if (promoInput && skuData.promotion) {
              promoInput.value = skuData.promotion;
            }
            if (giftInput && skuData.gift) {
              giftInput.value = skuData.gift;
            }
          }
        } else {
          notFoundSkus.push(skuValue);
        }
      });

      // Debug: log k·∫øt qu·∫£
      console.log(`ƒê√£ tick ${tickedCount}/${window._copyCtkmSkusToTick.length} SKU t·ª´ CTKM c≈©`);
      if (notFoundSkus.length > 0) {
        console.log('SKU kh√¥ng t√¨m th·∫•y trong brand hi·ªán t·∫°i:', notFoundSkus);
        console.log('C√≥ th·ªÉ c√°c SKU n√†y thu·ªôc brand kh√°c. H√£y ƒë·ªïi brand ƒë·ªÉ tick ch√∫ng.');
      }
    }

    // --- CTKM THEO TH√ÅNG / H·ªÜ TH·ªêNG (FORM TH√äM M·ªöI) ---
    function getMonthNumber(mStr) {
      if (!mStr) return null;
      const m = String(mStr).match(/\d+/);
      return m ? parseInt(m[0], 10) : null;
    }

    function onMonthYearChange() {
      const sys = document.getElementById('system').value;
      const mVal = parseInt(document.getElementById('month').value, 10);
      const yVal = parseInt(document.getElementById('year').value, 10);
      const sel = document.getElementById('existing_ctkm');

      if (!sel) return;

      sel.innerHTML = '<option value=\"\">-- Ch·ªçn CTKM c√≥ trong Timeline ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·∫°o m·ªõi --</option>';
      document.getElementById('timeline_info').innerText = '';

      if (!sys || !mVal || !yVal || !currentList.length) return;

      const cs = clean(sys);
      const names = new Set();

      currentList.forEach(item => {
        if (clean(item.system) !== cs) return;
        const im = getMonthNumber(item.month);
        const iy = parseInt(item.year, 10);
        if (im === mVal && iy === yVal) {
          names.add(item.name);
        }
      });

      [...names].sort().forEach(n => {
        sel.innerHTML += `<option value="${n}">${n}</option>`;
      });
    }

    function onSelectExistingCtkm() {
      const n = document.getElementById('existing_ctkm').value;
      const sys = document.getElementById('system').value;
      const info = document.getElementById('timeline_info');

      if (!n) {
        info.innerText = '';
        return;
      }

      const cs = clean(sys);
      const match = currentList.find(
        x => clean(x.system) === cs && String(x.name).trim() === String(n).trim()
      );

      if (match) {
        document.getElementById('name').value = match.name;
        if (match.start_date && match.end_date) {
          flatpickrInstance.setDate([match.start_date, match.end_date]);
        }
        info.innerText = `Timeline: ${formatDate(match.start_date)} ƒë·∫øn ${formatDate(match.end_date)}`;
      } else {
        info.innerText = '';
      }
    }

    function toggleAllSku(src) {
      document.querySelectorAll('.sku-check').forEach(c => c.checked = src.checked);
    }

    async function saveBatchData() {
      const com = {
        name:  document.getElementById('name').value,
        month: document.getElementById('month').value,
        year:  document.getElementById('year').value,
        system:document.getElementById('system').value,
        brand: document.getElementById('brand').value,
        date_range: document.getElementById('date_range').value,
        delivery_offset: document.getElementById('delivery_offset').value,
        note:  document.getElementById('note').value
      };

      if (!com.name) return alert("Nh·∫≠p t√™n!");

      const items = [];
      document.querySelectorAll('.sku-check:checked').forEach(c => {
        const r = c.closest('tr');
        items.push({
          sku: c.value,
          promotion: r.querySelector('.sku-promo').value,
          gift:      r.querySelector('.sku-gift').value
        });
      });

      if (!items.length) return alert("Ch·ªçn SP!");

      const btn = document.querySelector('#dataModal .btn-success');
      btn.innerHTML = '...';
      btn.disabled = true;

      try {
        await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action:'save', data:{ common:com, items:items } })
        });
        alert("ƒê√£ l∆∞u!");
        modalData.hide();
        // Reset copy data
        window._copyCtkmSkusToTick = null;
        copyCtkmData = null;
        fetchList();
      } catch (e) {
        alert(e);
      } finally {
        btn.innerHTML = 'L∆ØU T·∫§T C·∫¢';
        btn.disabled = false;
      }
    }

    function openPrintModal() {
      const s = document.getElementById('print_system');
      s.innerHTML = '<option value="">-- Ch·ªçn --</option>';
      [...new Set(currentList.map(i => i.system))].sort().forEach(x => {
        s.innerHTML += `<option value="${x}">${x}</option>`;
      });

      const b = document.getElementById('print_brand');
      if (b) {
        b.innerHTML = '<option value="">-- T·∫•t c·∫£ --</option>';
        [...new Set(currentList.map(i => i.brand).filter(Boolean))].sort().forEach(x => {
          b.innerHTML += `<option value="${x}">${x}</option>`;
        });
      }
      modalPrint.show();
    }

    function openPrintTimelineModal() {
      // Populate print modal controls then show
      populatePrintTimelineModalControls();
      modalTimelinePrint.show();
      // Load and preview timeline data
      updateTimelinePreview();
    }

    function updateTimelinePreview() {
      const view = document.querySelector('input[name="timeline_view"]:checked')?.value || 'system';
      const previewArea = document.getElementById('timeline_preview_area');
      
      const listToUse = getPrintFilteredList();
      if (!listToUse || !listToUse.length) {
        previewArea.innerHTML = '<div class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu CTKM</div>';
        return;
      }

      // Group data by month
      const monthMap = {};
      listToUse.forEach(item => {
        // extract month/year robustly
        let monthNum = item.month ? parseInt(item.month) : 0;
        let yearNum = item.year ? parseInt(item.year) : 0;
        if (!monthNum && item.start_date) {
          const parts = String(item.start_date).split('-');
          if (parts.length >= 2) {
            yearNum = parseInt(parts[0]);
            monthNum = parseInt(parts[1]);
          }
        }
        if (!monthNum || isNaN(monthNum)) monthNum = 1;
        if (!yearNum || isNaN(yearNum)) yearNum = new Date().getFullYear();
        const key = `${yearNum}-${String(monthNum).padStart(2, '0')}`;
        if (!monthMap[key]) monthMap[key] = [];
        monthMap[key].push(item);
      });

      // Get last 4 months
      const sortedMonths = Object.keys(monthMap).sort().reverse().slice(0, 4).sort();
      
      if (!sortedMonths.length) {
        previewArea.innerHTML = '<div class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu trong 4 th√°ng g·∫ßn nh·∫•t</div>';
        return;
      }

      let html = '<div class="timeline-preview">';

      // If print modal system/brand filters are set, show CTKM table instead of month grouping
      const printSys = document.getElementById('print_tl_system_select') ? String(document.getElementById('print_tl_system_select').value || '').trim() : '';
      const printBrand = document.getElementById('print_tl_brand_select') ? String(document.getElementById('print_tl_brand_select').value || '').trim() : '';

      if (printSys || printBrand) {
        // Build unique CTKM rows filtered by selected system/brand
        const ctkmMap = {};
        Object.keys(monthMap).forEach(k => {
          monthMap[k].forEach(item => {
            const sys = String(item.system || '').trim();
            const br = String(item.brand || '').trim();
            if (printSys && !(sys === printSys || sys.includes(printSys) || printSys.includes(sys))) return;
            if (printBrand && !(br === printBrand || br.includes(printBrand) || printBrand.includes(br))) return;
            const name = String(item.name || '').trim() || '(Kh√¥ng t√™n)';
            if (!ctkmMap[name]) ctkmMap[name] = { system: sys, brand: br, items: [] };
            ctkmMap[name].items.push(item);
          });
        });

        // Render table
        html += `<div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>H·ªá th·ªëng</th><th>T√™n CTKM</th><th>NG√ÄY KM</th><th>TH·ªúI GIAN GIAO H√ÄNG KM</th></tr></thead><tbody>`;

        const formatIso = (iso) => {
          if (!iso) return '';
          const p = String(iso).split('-');
          if (p.length < 3) return iso;
          return `${String(p[2]).padStart(2,'0')}/${String(p[1]).padStart(2,'0')}/${p[0]}`;
        };

        Object.keys(ctkmMap).sort().forEach(name => {
          const info = ctkmMap[name];
          const first = info.items[0];
          const start = first.start_date || '';
          const end = first.end_date || '';
          const dateRange = start && end ? `${formatIso(start)} - ${formatIso(end)}` : '';
          const del = first.delivery_str || '';
          html += `<tr><td>${info.system}</td><td><strong>${name}</strong></td><td>${dateRange}</td><td>${del}</td></tr>`;
        });

        html += `</tbody></table></div>`;
      } else {
        // Default month grouped view
        sortedMonths.forEach(monthKey => {
          const items = monthMap[monthKey];
          const [year, month] = monthKey.split('-');
          html += `<div class="mb-4">
            <h6 class="fw-bold text-primary border-bottom pb-2">
              <i class="fa-solid fa-calendar-days me-2"></i>Th√°ng ${parseInt(month)} / ${year}
            </h6>`;
          
          if (view === 'system') {
            // Group by system
            const systemMap = {};
            items.forEach(item => {
              if (!systemMap[item.system]) systemMap[item.system] = [];
              systemMap[item.system].push(item);
            });
            
            Object.keys(systemMap).sort().forEach(sys => {
              html += `<div class="ms-3 mb-2">
                <div class="text-muted small"><strong>üìç ${sys}</strong></div>`;
              systemMap[sys].forEach(item => {
                html += `<div class="ms-3" style="font-size:12px">
                  ‚Ä¢ ${item.name} (SKU: ${item.sku})
                </div>`;
              });
              html += `</div>`;
            });
          } else {
            // Group by SKU
            const skuMap = {};
            items.forEach(item => {
              if (!skuMap[item.sku]) skuMap[item.sku] = [];
              skuMap[item.sku].push(item);
            });
            
            Object.keys(skuMap).sort().forEach(sku => {
              html += `<div class="ms-3 mb-2">
                <div class="text-muted small"><strong>üè∑Ô∏è ${sku}</strong></div>`;
              skuMap[sku].forEach(item => {
                html += `<div class="ms-3" style="font-size:12px">
                  ‚Ä¢ ${item.system} - ${item.name}
                </div>`;
              });
              html += `</div>`;
            });
          }
          
          html += `</div>`;
        });
      }

      html += '</div>';
      previewArea.innerHTML = html;
    }

    async function executeTimelinePrint() {
      const view = document.querySelector('input[name="timeline_view"]:checked')?.value || 'system';
      const btn = document.querySelector('#printTimelineModal .btn-info');
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>ƒêang t·∫°o PDF...';
      btn.disabled = true;

      try {
        // T·∫°o d·ªØ li·ªáu ƒë·ªÉ print
        const monthMap = {};
        const listToUse = getPrintFilteredList();
        listToUse.forEach(item => {
          // Extract th√°ng t·ª´ start_date (format: YYYY-MM-DD)
          let monthNum = item.month ? parseInt(item.month) : 0;
          let yearNum = item.year ? parseInt(item.year) : 0;
          
          if (!monthNum && item.start_date) {
            const [dateYear, dateMonth, dateDay] = String(item.start_date).split('-');
            monthNum = parseInt(dateMonth);
            yearNum = parseInt(dateYear);
          }
          
          // Fallback n·∫øu v·∫´n kh√¥ng c√≥
          if (!monthNum || isNaN(monthNum)) monthNum = 1;
          if (!yearNum || isNaN(yearNum)) yearNum = new Date().getFullYear();
          
          const key = `${yearNum}-${String(monthNum).padStart(2, '0')}`;
          if (!monthMap[key]) monthMap[key] = [];
          monthMap[key].push(item);
        });

        const sortedMonths = Object.keys(monthMap).sort().reverse().slice(0, 4).sort();
        
        const timelineData = {
          viewMode: view,
          months: sortedMonths.map(monthKey => {
            const [year, month] = monthKey.split('-');
            const items = monthMap[monthKey];
            return {
              year: parseInt(year),
              month: parseInt(month),
              items: items
            };
          })
        };
        // include print modal filters
        const printSys = document.getElementById('print_tl_system_select') ? String(document.getElementById('print_tl_system_select').value || '').trim() : '';
        const printBrand = document.getElementById('print_tl_brand_select') ? String(document.getElementById('print_tl_brand_select').value || '').trim() : '';
        timelineData.printSystem = printSys;
        timelineData.printBrand = printBrand;

        console.log('Timeline data:', timelineData);

        // G·ª≠i request in PDF
        const r = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'save_timeline_pdf', data: timelineData })
        });
        
        const j = await r.json();
        
        if (j.success) {
          alert('ƒê√£ in Timeline th√†nh c√¥ng!\nFile: ' + j.data.message);
          modalTimelinePrint.hide();
        } else {
          alert('L·ªói: ' + (j.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
        }
      } catch (e) {
        alert('L·ªói: ' + e);
      } finally {
        btn.innerHTML = '<i class="fa-solid fa-file-pdf me-1"></i>IN PDF';
        btn.disabled = false;
      }
    }

    function loadPrintCtkmList() {
      const s = document.getElementById('print_system').value;
      const b = document.getElementById('print_brand') ? document.getElementById('print_brand').value : '';
      const c = document.getElementById('print_ctkm');

      c.innerHTML = '<option>-- Ch·ªçn --</option>';
      document.getElementById('sku_input_area').style.display = 'none';
      const info = document.getElementById('print_timeline_info');
      if (info) info.innerText = '';

      if (!s) {
        c.disabled = true;
        return;
      }

      // So kh·ªõp h·ªá th·ªëng "m·ªÅm" (EMART, EMART GMS, LOTTE, LOTTE MART...) ƒë·ªÉ tr√°nh l·ªách t√™n
      const cs = clean(s);
      const cb = b ? clean(b) : '';

      const u = [...new Set(
        currentList
          .filter(i => {
            const sys = clean(i.system);
            const br = clean(i.brand);
            const matchSys = sys === cs || sys.includes(cs) || cs.includes(sys);
            const matchBrand = !cb || br === cb || br.includes(cb) || cb.includes(br);
            return matchSys && matchBrand;
          })
          .map(i => i.name)
      )];
      u.sort().forEach(n => {
        c.innerHTML += `<option value="${n}">${n}</option>`;
      });
      c.disabled = false;
    }

    function renderSkuInputTable() {
      const n = document.getElementById('print_ctkm').value;
      const s = document.getElementById('print_system').value;
      const b = document.getElementById('print_brand') ? document.getElementById('print_brand').value : '';
      const t = document.getElementById('sku_input_tbody');

      if (!n) {
        document.getElementById('sku_input_area').style.display = 'none';
        updatePrintTimelineInfo('');
        return;
      }

      updatePrintTimelineInfo(n);

      t.innerHTML = '';
      
      const cs = clean(s);
      const cb = b ? clean(b) : '';

      // So kh·ªõp t√™n CTKM theo d·∫°ng ƒë√£ trim ƒë·ªÉ tr√°nh l·ªách d·∫•u c√°ch
      currentList.filter(i => {
        const sys = clean(i.system);
        const br = clean(i.brand);
        const matchSys = sys === cs || sys.includes(cs) || cs.includes(sys);
        const matchBrand = !cb || br === cb || br.includes(cb) || cb.includes(br);
        return String(i.name).trim() === String(n).trim() && matchSys && matchBrand;
      }).forEach((i, idx) => {
        t.innerHTML += `
          <tr>
            <td><b>${i.sku}</b></td>
            <td><small>${i.promotion}</small></td>
            <td><input type="number" class="form-control form-control-sm text-center qty-input" value="1000"></td>
            <td><input type="text" class="form-control form-control-sm gift-input" value="${i.gift || ''}" placeholder=""></td>
          </tr>`;
      });

      document.getElementById('sku_input_area').style.display = 'block';
    }

    // Hi·ªÉn th·ªã th√¥ng tin timeline khi ch·ªçn CTKM trong modal In & T·∫£i File
    function updatePrintTimelineInfo(name) {
      const info = document.getElementById('print_timeline_info');
      if (!info) return;

      if (!name) {
        info.innerText = '';
        return;
      }

      const match = currentList.find(i => String(i.name).trim() === String(name).trim());
      if (match && match.start_date && match.end_date) {
        info.innerText = `Timeline: ${formatDate(match.start_date)} - ${formatDate(match.end_date)}`;
      } else {
        info.innerText = '';
      }
    }

    function fmt(n) {
      return n ? Number(n).toLocaleString('vi-VN') : '0';
    }

    function setBreadcrumb(mode, itemData) {
      try {
        const bc = document.getElementById('breadcrumb');
        if (!bc) return;
        
        let breadcrumbText = '';
        const icon = '<i class="fa-solid fa-sitemap me-1"></i>';
        
        if (itemData) {
          // Show detailed breadcrumb with actual item data
          const brand = String(itemData.brand || '').trim() || '?';
          const system = String(itemData.system || '').trim() || '?';
          const sku = String(itemData.sku || '').trim() || '?';
          
          if (mode === 'sku') {
            breadcrumbText = `${icon}<strong>${sku}</strong> ‚Üí ${system}`;
          } else {
            breadcrumbText = `${icon}${brand} ‚Üí ${system} ‚Üí <strong>${sku}</strong>`;
          }
        } else {
          // Show mode label when no item is selected
          if (mode === 'sku') {
            breadcrumbText = `${icon}Nh√£n ‚Üí SKU ‚Üí H·ªá th·ªëng`;
          } else {
            breadcrumbText = `${icon}Nh√£n ‚Üí H·ªá th·ªëng ‚Üí SKU`;
          }
        }
        
        bc.innerHTML = breadcrumbText;
      } catch (e) {}
    }

    function slug(t) {
      return t.toString().toLowerCase()
        .replace(/\s+/g,'-')
        .replace(/[^\w\-]+/g,'');
    }

    // --- COPY CTKM (K√âO TH·∫¢) ---
    let copyCtkmData = null;

    function openCopyCtkmModal(item, newStart, newEnd, allSkusParam = null) {
      // L·∫•y T·∫§T C·∫¢ SKU c·ªßa CTKM c≈© (t·ª´ tham s·ªë ho·∫∑c t·ª± l·∫•y)
      let allSkus = allSkusParam;
      if (!allSkus || !allSkus.length) {
        allSkus = currentList.filter(i => 
          String(i.name).trim().toUpperCase() === String(item.name).trim().toUpperCase() &&
          clean(i.system) === clean(item.system)
        );
      }

      if (!allSkus.length) {
        alert('Kh√¥ng t√¨m th·∫•y SKU trong CTKM n√†y!');
        return;
      }

      copyCtkmData = {
        oldCtkmName: item.name,
        newStart: newStart,
        newEnd: newEnd,
        system: item.system,
        allSkus: allSkus
      };

      // Reset form
      document.getElementById('promoForm').reset();
      document.getElementById('editMode').value = 'create';
      document.getElementById('modalTitle').innerText = 'Copy CTKM - Th√™m M·ªõi';

      // Pre-fill th√¥ng tin c∆° b·∫£n
      const newMonth = newStart.getMonth() + 1;
      const newYear = newStart.getFullYear();
      document.getElementById('month').value = newMonth;
      document.getElementById('year').value = newYear;
      document.getElementById('system').value = item.system;

      // Set th·ªùi gian m·ªõi
      flatpickrInstance.setDate([newStart, newEnd]);

      // Load brand v√† SKU
      onSystemChange_Add();

      // L∆∞u danh s√°ch SKU c·∫ßn tick (ƒë·ªÉ d√πng khi ƒë·ªïi brand)
      // Bao g·ªìm c·∫£ brand ƒë·ªÉ c√≥ th·ªÉ tick ƒë√∫ng khi ƒë·ªïi brand
      window._copyCtkmSkusToTick = allSkus.map(s => ({
        sku: String(s.sku || '').trim(),
        brand: String(s.brand || '').trim(),
        promotion: String(s.promotion || '').trim(),
        gift: String(s.gift || '').trim()
      }));

      console.log('Copy CTKM - SKUs to tick:', window._copyCtkmSkusToTick.length, window._copyCtkmSkusToTick);

      // L·∫•y t·∫•t c·∫£ brand t·ª´ CTKM
      const allBrands = [...new Set(allSkus.map(s => s.brand).filter(Boolean))];
      console.log('Copy CTKM - Brands:', allBrands);

      // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ brand dropdown load xong
      setTimeout(() => {
        // T√¨m brand t·ª´ SKU ƒë·∫ßu ti√™n
        const firstSku = allSkus[0];
        if (firstSku && firstSku.brand) {
          document.getElementById('brand').value = firstSku.brand;
          onBrandChange_Add();

          // ƒê·ª£i SKU table load xong, r·ªìi tick c√°c SKU t·ª´ CTKM c≈©
          // TƒÉng timeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render xong
          setTimeout(() => {
            tickCopyCtkmSkus();
            
            // N·∫øu c√≥ nhi·ªÅu brand, tick SKU t·ª´ c√°c brand kh√°c
            if (allBrands.length > 1) {
              console.log(`CTKM n√†y c√≥ ${allBrands.length} brand: ${allBrands.join(', ')}. ƒê√£ tick SKU t·ª´ brand "${firstSku.brand}". B·∫°n c√≥ th·ªÉ ƒë·ªïi brand ƒë·ªÉ tick th√™m SKU t·ª´ brand kh√°c.`);
              // Hi·ªÉn th·ªã th√¥ng b√°o cho user
              const infoDiv = document.createElement('div');
              infoDiv.className = 'alert alert-info mt-2';
              infoDiv.innerHTML = `<strong>L∆∞u √Ω:</strong> CTKM n√†y c√≥ ${allBrands.length} brand (${allBrands.join(', ')}). ƒê√£ tick SKU t·ª´ brand "${firstSku.brand}". B·∫°n c√≥ th·ªÉ ƒë·ªïi brand ·ªü tr√™n ƒë·ªÉ tick th√™m SKU t·ª´ brand kh√°c.`;
              const form = document.getElementById('promoForm');
              if (form) {
                const existingAlert = form.querySelector('.alert-info');
                if (existingAlert) existingAlert.remove();
                form.appendChild(infoDiv);
              }
            }
          }, 600);
        } else {
          // N·∫øu kh√¥ng c√≥ brand, v·∫´n tick SKU n·∫øu c√≥
          setTimeout(() => {
            tickCopyCtkmSkus();
          }, 600);
        }
      }, 300);

      // Load CTKM c√≥ s·∫µn trong th√°ng m·ªõi
      onMonthYearChange();

      modalData.show();
    }

    // --- DRAG & DROP CTKM (OLD - GI·ªÆ L·∫†I ƒê·ªÇ T∆Ø∆†NG TH√çCH) ---
    let dragDropData = null;

    function openDragDropModal(item, newStart, newEnd) {
      dragDropData = {
        oldItem: item,
        newStart: newStart,
        newEnd: newEnd
      };

      document.getElementById('dd_old_ctkm').innerText = `${item.name} (${item.system} - ${item.sku})`;
      document.getElementById('dd_new_dates').innerText = 
        `${formatDate(newStart)} ƒë·∫øn ${formatDate(newEnd)}`;
      document.getElementById('dd_new_ctkm').value = '';
      document.getElementById('dd_existing_ctkm').innerHTML = 
        '<option value="">-- Ch·ªçn CTKM c√≥ s·∫µn ho·∫∑c nh·∫≠p t√™n m·ªõi --</option>';
      document.getElementById('dd_delivery_offset').value = '0';

      // Load CTKM c√≥ s·∫µn trong th√°ng m·ªõi
      const newMonth = newStart.getMonth() + 1;
      const newYear = newStart.getFullYear();
      const sys = item.system;

      const sel = document.getElementById('dd_existing_ctkm');
      const names = new Set();

      currentList.forEach(i => {
        if (clean(i.system) !== clean(sys)) return;
        const im = getMonthNumber(i.month);
        const iy = parseInt(i.year, 10);
        if (im === newMonth && iy === newYear) {
          names.add(i.name);
        }
      });

      [...names].sort().forEach(n => {
        sel.innerHTML += `<option value="${n}">${n}</option>`;
      });

      const modalDragDrop = new bootstrap.Modal(document.getElementById('dragDropModal'));
      modalDragDrop.show();
    }

    function onSelectDragDropCtkm() {
      const n = document.getElementById('dd_existing_ctkm').value;
      if (n) {
        document.getElementById('dd_new_ctkm').value = n;
      }
    }

    async function confirmDragDrop() {
      if (!dragDropData) return;

      const newCtkmName = document.getElementById('dd_new_ctkm').value.trim();
      if (!newCtkmName) {
        return alert('Nh·∫≠p t√™n CTKM m·ªõi!');
      }

      const btn = document.querySelector('#dragDropModal .btn-primary');
      btn.innerHTML = '...';
      btn.disabled = true;

      try {
        const payload = {
          oldCtkmName: dragDropData.oldItem.name,
          newCtkmName: newCtkmName,
          newStartDate: dragDropData.newStart.toISOString(),
          newEndDate: dragDropData.newEnd.toISOString(),
          system: dragDropData.oldItem.system,
          sku: dragDropData.oldItem.sku,
          deliveryOffset: parseInt(document.getElementById('dd_delivery_offset').value, 10)
        };

        const r = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'update_timeline', data: payload })
        });

        const j = await r.json();

        if (j.success) {
          alert(j.data.message || 'ƒê√£ c·∫≠p nh·∫≠t!');
          const modalDragDrop = bootstrap.Modal.getInstance(document.getElementById('dragDropModal'));
          modalDragDrop.hide();
          await fetchList(); // Reload timeline
        } else {
          alert(j.error || 'L·ªói!');
        }
      } catch (e) {
        alert('L·ªói: ' + e);
      } finally {
        btn.innerHTML = 'C·∫¨P NH·∫¨T';
        btn.disabled = false;
        dragDropData = null;
      }
    }

    function formatDate(d) {
      // N·∫øu kh√¥ng c√≥ ng√†y th√¨ tr·∫£ chu·ªói tr·ªëng ƒë·ªÉ tr√°nh hi·ªán "..."
      if (!d) return '';
      const dt = new Date(d);
      return `${dt.getDate()}/${dt.getMonth()+1}/${dt.getFullYear()}`;
    }

    // ============================================
    // GUIDELINE MANAGEMENT FUNCTIONS
    // ============================================

    /**
     * M·ªü modal Guideline v√† load d·ªØ li·ªáu
     */
    async function openGuidelineModal() {
      modalGuideline.show();
      await fetchGuidelineData();
    }

    /**
     * T·∫£i d·ªØ li·ªáu guideline t·ª´ server
     */
    async function fetchGuidelineData() {
      try {
        const tbody = document.getElementById('guideline_table_body');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3"><i class="fa-solid fa-spinner fa-spin me-2"></i>ƒêang t·∫£i...</td></tr>';
        }

        const response = await fetch(`${API_URL}?action=guideline&t=${Date.now()}`);
        const data = await response.json();

        if (data.success) {
          guidelineData = data.data || [];
          if (tbody) {
            renderGuidelineTable();
          }
        } else {
          if (tbody) {
            alert('L·ªói t·∫£i guideline: ' + (data.error || 'Unknown'));
          }
          console.warn('fetchGuidelineData error:', data.error);
        }
      } catch (error) {
        console.warn('fetchGuidelineData error:', error);
        // Kh√¥ng alert ƒë·ªÉ tr√°nh gi√°n ƒëo·∫°n khi load trang
      }
    }

    /**
     * Hi·ªÉn th·ªã b·∫£ng guideline
     */
    function renderGuidelineTable() {
      const tbody = document.getElementById('guideline_table_body');
      
      if (!guidelineData || guidelineData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Ch∆∞a c√≥ guideline n√†o</td></tr>';
        return;
      }

      // S·∫Øp x·∫øp theo nƒÉm, th√°ng, SKU
      guidelineData.sort((a, b) => {
        const yearDiff = parseInt(b.year) - parseInt(a.year);
        if (yearDiff !== 0) return yearDiff;
        const monthDiff = parseInt(b.month) - parseInt(a.month);
        if (monthDiff !== 0) return monthDiff;
        return (a.sku || '').localeCompare(b.sku || '');
      });

      let html = '';
      guidelineData.forEach((item, index) => {
        html += `
          <tr>
            <td class="text-center">${index + 1}</td>
            <td><strong>${item.sku}</strong></td>
            <td class="text-center">Th√°ng ${item.month}</td>
            <td class="text-center">${item.year}</td>
            <td>${item.note || '<span class="text-muted">--</span>'}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-danger" onclick="deleteGuidelineItem('${item.sku}', '${item.month}', '${item.year}')" title="X√≥a">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    /**
     * L∆∞u guideline (th√™m m·ªõi ho·∫∑c c·∫≠p nh·∫≠t)
     */
    async function saveGuidelineData(event) {
      event.preventDefault();

      const sku = document.getElementById('guideline_sku').value.trim();
      const month = document.getElementById('guideline_month').value;
      const year = document.getElementById('guideline_year').value;
      const note = document.getElementById('guideline_note').value.trim();

      if (!sku || !month || !year) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß SKU, Th√°ng v√† NƒÉm!');
        return;
      }

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'save_guideline',
            data: { sku, month, year, note }
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(data.data.message || 'ƒê√£ l∆∞u guideline!');
          document.getElementById('guidelineForm').reset();
          await fetchGuidelineData();
          await fetchList(); // Reload timeline ƒë·ªÉ c·∫≠p nh·∫≠t m√†u s·∫Øc
        } else {
          alert('L·ªói: ' + (data.error || 'Unknown'));
        }
      } catch (error) {
        alert('L·ªói: ' + error.message);
        console.error('saveGuidelineData error:', error);
      }
    }

    /**
     * X√≥a guideline
     */
    async function deleteGuidelineItem(sku, month, year) {
      if (!confirm(`X√≥a guideline cho SKU "${sku}" th√°ng ${month}/${year}?`)) {
        return;
      }

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'delete_guideline',
            data: { sku, month, year }
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(data.data.message || 'ƒê√£ x√≥a guideline!');
          await fetchGuidelineData();
          await fetchList(); // Reload timeline ƒë·ªÉ c·∫≠p nh·∫≠t m√†u s·∫Øc
        } else {
          alert('L·ªói: ' + (data.error || 'Unknown'));
        }
      } catch (error) {
        alert('L·ªói: ' + error.message);
        console.error('deleteGuidelineItem error:', error);
      }
    }

    /**
     * Ki·ªÉm tra SKU c√≥ tu√¢n th·ªß guideline hay kh√¥ng
     * @param {string} sku - SKU code
     * @param {string} month - Month (format: "TH√ÅNG 1" ho·∫∑c "1")
     * @param {string} year - Year
     * @returns {boolean|null} - true n·∫øu c√≥ promo ƒë√∫ng guideline, false n·∫øu c√≥ guideline nh∆∞ng kh√¥ng c√≥ promo, null n·∫øu kh√¥ng c√≥ guideline
     */
    function checkSkuHasGuideline(sku, month, year) {
      if (!guidelineData || guidelineData.length === 0) return null;

      // Parse month number from "TH√ÅNG 1" format
      let monthNum = month;
      if (typeof month === 'string' && month.includes('TH√ÅNG')) {
        monthNum = month.replace('TH√ÅNG', '').trim();
      }

      // T√¨m guideline
      const guideline = guidelineData.find(g => 
        clean(g.sku) === clean(sku) &&
        String(g.month) === String(monthNum) &&
        String(g.year) === String(year)
      );

      if (!guideline) return null; // Kh√¥ng c√≥ guideline

      // C√≥ guideline - ki·ªÉm tra xem c√≥ CTKM th·ª±c t·∫ø trong Data_CTKM kh√¥ng
      const hasPromo = currentList.some(item => 
        clean(item.sku) === clean(sku) &&
        String(item.month).includes(String(monthNum)) &&
        String(item.year) === String(year)
      );

      return hasPromo;
    }

    /**
     * L·∫•y m√†u cho item d·ª±a tr√™n guideline compliance
     * @returns {object} - { background, border } colors
     */
    function getItemColorByGuideline(item) {
      const monthNum = getMonthNumber(item.month);
      const compliance = checkSkuHasGuideline(item.sku, monthNum, item.year);

      if (compliance === null) {
        // Kh√¥ng c√≥ guideline - m√†u m·∫∑c ƒë·ªãnh (xanh d∆∞∆°ng)
        return {
          background: '#e7f1ff',
          border: '#0d6efd'
        };
      } else if (compliance === true) {
        // ƒê√∫ng guideline - m√†u xanh l√°
        return {
          background: '#d4edda',
          border: '#28a745'
        };
      } else {
        // Sai guideline - m√†u ƒë·ªè/cam
        return {
          background: '#fff3cd',
          border: '#ffc107'
        };
      }
    }
  </script>
</body>
</html>